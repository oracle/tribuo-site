---
title: "Configuration"
og-title: "Configuration Tutorial"
learn_nav: true
parent: Tutorials
nav_order: 307
is_notebook: true
notebook_url: https://github.com/oracle/tribuo/blob/main/tutorials/configuration-tribuo-v4.ipynb
comment: ## DO NOT EDIT THIS FILE. IT IS COPIED FROM THE TRIBUO DOC. EDIT IT THERE. ##
---
<main>
<div class="border-box-sizing" id="notebook" tabindex="-1">
<div class="container" id="notebook-container">
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Configuration-Tutorial">Configuration Tutorial<a class="anchor-link" href="#Configuration-Tutorial">¶</a></h1><p>This tutorial will show how to use Tribuo's configuration and provenance systems to build models on MNIST (because we wouldn't be doing ML without an MNIST demo).
We'll focus on logistic regression, show how many different trainers can be stored in the same configuration, and how the provenance system allows the configuration for a specific run to be regenerated.
We'll also briefly look at Tribuo's feature transformation system and see how that integrates into configuration and provenance.</p>
<h2 id="Setup">Setup<a class="anchor-link" href="#Setup">¶</a></h2><p>You'll need to get a copy of the MNIST dataset in libSVM format.</p>
<p><code>wget https://www.csie.ntu.edu.tw/~cjlin/libsvmtools/datasets/multiclass/mnist.bz2</code></p>
<p><code>wget https://www.csie.ntu.edu.tw/~cjlin/libsvmtools/datasets/multiclass/mnist.t.bz2</code></p>
<p>Then unzip them using your preferred method (e.g. <code>bunzip2 &lt;file-name&gt;</code>).</p>
<p>It's Java, so first we load in the necessary Tribuo jars. Here we're using the classification experiments jar, along with the json interop jar to read and write the provenance information.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [1]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-java"><pre><span></span><span class="o">%</span><span class="n">jars</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">olcut</span><span class="o">-</span><span class="n">core</span><span class="o">-</span><span class="mf">5.1.4</span><span class="o">-</span><span class="n">SNAPSHOT</span><span class="p">.</span><span class="na">jar</span>
<span class="o">%</span><span class="n">jars</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">tribuo</span><span class="o">-</span><span class="n">classification</span><span class="o">-</span><span class="n">experiments</span><span class="o">-</span><span class="mf">4.0.0</span><span class="o">-</span><span class="n">SNAPSHOT</span><span class="o">-</span><span class="n">jar</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">dependencies</span><span class="p">.</span><span class="na">jar</span>
<span class="o">%</span><span class="n">jars</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">tribuo</span><span class="o">-</span><span class="n">json</span><span class="o">-</span><span class="mf">4.0.0</span><span class="o">-</span><span class="n">SNAPSHOT</span><span class="o">-</span><span class="n">jar</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">dependencies</span><span class="p">.</span><span class="na">jar</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now lets import the packages we need. We'll use a few file manipulation things from Java, and then Tribuo's core packages, the transformation packages, the classification package, classification evaluation package, and then a few things that relate to the provenance system.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [2]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-java"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.nio.file.Files</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.nio.file.Paths</span><span class="p">;</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [3]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-java"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">org.tribuo.*</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.tribuo.util.Util</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.tribuo.transform.*</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.tribuo.transform.transformations.LinearScalingTransformation</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.tribuo.classification.*</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.tribuo.classification.evaluation.*</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.oracle.labs.mlrg.olcut.config.ConfigurationManager</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.oracle.labs.mlrg.olcut.provenance.*</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.oracle.labs.mlrg.olcut.provenance.primitives.*</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.oracle.labs.mlrg.olcut.config.json.JsonConfigFactory</span><span class="p">;</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>By default OLCUT's <code>ConfigurationManager</code> only understands XML files, this snippet adds JSON support to all <code>ConfigurationManager</code>s in the running JVM. It can be added dynamically on the command line by supplying <code>--config-file-format &lt;fully-qualified-class-name&gt;</code> where the class name is for example <code>com.oracle.labs.mlrg.olcut.config.json.JsonConfigFactory</code>, if you're using OLCUT's CLI options processing.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [4]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-java"><pre><span></span><span class="n">ConfigurationManager</span><span class="p">.</span><span class="na">addFileFormatFactory</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">JsonConfigFactory</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Using-a-configuration-file">Using a configuration file<a class="anchor-link" href="#Using-a-configuration-file">¶</a></h2><p>We're going to read in an example configuration file, in JSON format. This configuration knows about a bunch of different trainers, and also the training and testing MNIST data sources. In the tutorials directory we supply both the JSON and XML versions of this file, and the remainder of this tutorial is completely agnostic to which one is used.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [5]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-java"><pre><span></span><span class="n">String</span><span class="w"> </span><span class="n">configFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"example-config.json"</span><span class="p">;</span>
<span class="n">String</span><span class="p">.</span><span class="na">join</span><span class="p">(</span><span class="s">"\n"</span><span class="p">,</span><span class="n">Files</span><span class="p">.</span><span class="na">readAllLines</span><span class="p">(</span><span class="n">Paths</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">configFile</span><span class="p">)))</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt output_prompt">Out[5]:</div>
<div class="output_text output_subarea output_execute_result">
<pre>{
  "config" : {
    "components" : [ {
      "name" : "mnist-test",
      "type" : "org.tribuo.datasource.LibSVMDataSource",
      "export" : "false",
      "import" : "false",
      "properties" : {
        "path" : "mnist.t",
        "outputFactory" : "label-factory"
      }
    }, {
      "name" : "mnist-train",
      "type" : "org.tribuo.datasource.LibSVMDataSource",
      "export" : "false",
      "import" : "false",
      "properties" : {
        "path" : "mnist",
        "outputFactory" : "label-factory"
      }
    }, {
      "name" : "adagrad",
      "type" : "org.tribuo.math.optimisers.AdaGrad",
      "export" : "false",
      "import" : "false",
      "properties" : {
        "epsilon" : "0.01",
        "initialLearningRate" : "0.5"
      }
    }, {
      "name" : "log",
      "type" : "org.tribuo.classification.sgd.objectives.LogMulticlass",
      "export" : "false",
      "import" : "false"
    }, {
      "name" : "label-factory",
      "type" : "org.tribuo.classification.LabelFactory",
      "export" : "false",
      "import" : "false"
    }, {
      "name" : "gini",
      "type" : "org.tribuo.classification.dtree.impurity.GiniIndex",
      "export" : "false",
      "import" : "false"
    }, {
      "name" : "cart",
      "type" : "org.tribuo.classification.dtree.CARTClassificationTrainer",
      "export" : "false",
      "import" : "false",
      "properties" : {
        "maxDepth" : "6",
        "impurity" : "gini",
        "seed" : "12345",
        "fractionFeaturesInSplit" : "0.5"
      }
    }, {
      "name" : "entropy",
      "type" : "org.tribuo.classification.dtree.impurity.Entropy",
      "export" : "false",
      "import" : "false"
    }, {
      "name" : "logistic",
      "type" : "org.tribuo.classification.sgd.linear.LinearSGDTrainer",
      "export" : "false",
      "import" : "false",
      "properties" : {
        "seed" : "1",
        "minibatchSize" : "1",
        "epochs" : "2",
        "optimiser" : "adagrad",
        "objective" : "log",
        "loggingInterval" : "10000"
      }
    }, {
      "name" : "xgboost",
      "type" : "org.tribuo.classification.xgboost.XGBoostClassificationTrainer",
      "export" : "false",
      "import" : "false",
      "properties" : {
        "numTrees" : "10",
        "maxDepth" : "4",
        "eta" : "0.5",
        "seed" : "1",
        "minChildWeight" : "1.0",
        "subsample" : "1.0",
        "nThread" : "6",
        "gamma" : "0.1"
      }
    } ]
  }
}</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now we'll make a <code>ConfigurationManager</code> and hand it the configuration file to load. Our configuration system also supports CLI options which can load things out of the supplied configuration files. We have examples of this in each of the simple <code>TrainTest</code> demo classes in each prediction backend.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [6]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-java"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="n">cm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ConfigurationManager</span><span class="p">(</span><span class="n">configFile</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>First we'll load in the training and testing <code>DataSource</code>s (as instances of <code>LibSVMDataSource</code>), pass them into two <code>Dataset</code>s to aggregate the appropriate metadata, and we'll make the evaluator for later use.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [7]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-java"><pre><span></span><span class="n">DataSource</span><span class="o">&lt;</span><span class="n">Label</span><span class="o">&gt;</span><span class="w"> </span><span class="n">mnistTrain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">DataSource</span><span class="o">&lt;</span><span class="n">Label</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="n">cm</span><span class="p">.</span><span class="na">lookup</span><span class="p">(</span><span class="s">"mnist-train"</span><span class="p">);</span>
<span class="n">DataSource</span><span class="o">&lt;</span><span class="n">Label</span><span class="o">&gt;</span><span class="w"> </span><span class="n">mnistTest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">DataSource</span><span class="o">&lt;</span><span class="n">Label</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="n">cm</span><span class="p">.</span><span class="na">lookup</span><span class="p">(</span><span class="s">"mnist-test"</span><span class="p">);</span>
<span class="kd">var</span><span class="w"> </span><span class="n">trainData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MutableDataset</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">mnistTrain</span><span class="p">);</span>
<span class="kd">var</span><span class="w"> </span><span class="n">testData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MutableDataset</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">mnistTest</span><span class="p">);</span>
<span class="kd">var</span><span class="w"> </span><span class="n">evaluator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">LabelEvaluator</span><span class="p">();</span>
<span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="s">"Training data size = %d, number of features = %d, number of classes = %d"</span><span class="p">,</span><span class="n">trainData</span><span class="p">.</span><span class="na">size</span><span class="p">(),</span><span class="n">trainData</span><span class="p">.</span><span class="na">getFeatureMap</span><span class="p">().</span><span class="na">size</span><span class="p">(),</span><span class="n">trainData</span><span class="p">.</span><span class="na">getOutputInfo</span><span class="p">().</span><span class="na">size</span><span class="p">()));</span>
<span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="s">"Testing data size = %d, number of features = %d, number of classes = %d"</span><span class="p">,</span><span class="n">testData</span><span class="p">.</span><span class="na">size</span><span class="p">(),</span><span class="n">testData</span><span class="p">.</span><span class="na">getFeatureMap</span><span class="p">().</span><span class="na">size</span><span class="p">(),</span><span class="n">testData</span><span class="p">.</span><span class="na">getOutputInfo</span><span class="p">().</span><span class="na">size</span><span class="p">()));</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>Training data size = 60000, number of features = 717, number of classes = 10
Testing data size = 10000, number of features = 668, number of classes = 10
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Loading-in-trainers-from-the-configuration">Loading in trainers from the configuration<a class="anchor-link" href="#Loading-in-trainers-from-the-configuration">¶</a></h2><p>Our configuration file contains a number of different trainers, so let's pull them out and take a look.</p>
<p>The first one we'll see is a CART decision tree, with a max tree depth of 6.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [8]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-java"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="n">cart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Trainer</span><span class="o">&lt;</span><span class="n">Label</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="n">cm</span><span class="p">.</span><span class="na">lookup</span><span class="p">(</span><span class="s">"cart"</span><span class="p">);</span>
<span class="n">cart</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt output_prompt">Out[8]:</div>
<div class="output_text output_subarea output_execute_result">
<pre>CARTClassificationTrainer(maxDepth=6,minChildWeight=5.0,fractionFeaturesInSplit=0.5,impurity=GiniIndex,seed=12345)</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Next we'll load an XGBoost trainer, using 10 trees, 6 computation threads, and some regularisation parameters.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [9]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-java"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="n">xgb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Trainer</span><span class="o">&lt;</span><span class="n">Label</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="n">cm</span><span class="p">.</span><span class="na">lookup</span><span class="p">(</span><span class="s">"xgboost"</span><span class="p">);</span>
<span class="n">xgb</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt output_prompt">Out[9]:</div>
<div class="output_text output_subarea output_execute_result">
<pre>XGBoostTrainer(numTrees=10,parameters{colsample_bytree=1.0, silent=1, seed=1, max_depth=4, booster=gbtree, objective=multi:softprob, lambda=1.0, eta=0.5, nthread=6, alpha=1.0, subsample=1.0, gamma=0.1, min_child_weight=1.0})</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Finally we'll load in a logistic regression trainer, using AdaGrad as the gradient optimizer.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [10]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-java"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="n">logistic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Trainer</span><span class="o">&lt;</span><span class="n">Label</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="n">cm</span><span class="p">.</span><span class="na">lookup</span><span class="p">(</span><span class="s">"logistic"</span><span class="p">);</span>
<span class="n">logistic</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt output_prompt">Out[10]:</div>
<div class="output_text output_subarea output_execute_result">
<pre>LinearSGDTrainer(objective=LogMulticlass,optimiser=AdaGrad(initialLearningRate=0.5,epsilon=0.01,initialValue=0.0),epochs=2,minibatchSize=1,seed=1)</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We can also load a list in containing all the <code>Trainer</code> implementations in this config file. Note: the config system by default returns the same instance when it's queried for the same named config. So the list contains references to the objects we've already loaded.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [11]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-java"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="n">trainers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Trainer</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="n">cm</span><span class="p">.</span><span class="na">lookupAll</span><span class="p">(</span><span class="n">Trainer</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
<span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">"Loaded "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">trainers</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">" trainers."</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>Loaded 3 trainers.
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Training-the-model-and-extracting-configuration">Training the model and extracting configuration<a class="anchor-link" href="#Training-the-model-and-extracting-configuration">¶</a></h2><p>We're going to focus on the logistic regression trainer now, so let's train a logistic regression model on our MNIST training set.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [12]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-java"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="n">lrStartTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">();</span>
<span class="kd">var</span><span class="w"> </span><span class="n">lrModel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">logistic</span><span class="p">.</span><span class="na">train</span><span class="p">(</span><span class="n">trainData</span><span class="p">);</span>
<span class="kd">var</span><span class="w"> </span><span class="n">lrEndTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">();</span>
<span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">"Training logistic regression took "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Util</span><span class="p">.</span><span class="na">formatDuration</span><span class="p">(</span><span class="n">lrStartTime</span><span class="p">,</span><span class="n">lrEndTime</span><span class="p">));</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>Training logistic regression took (00:00:04:934)
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We can inspect the trained model for it's provenance, as we saw in the Classification tutorial.</p>
<p>The new step is extracting a configuration from that provenance. The <code>ProvenanceUtil.extractConfiguration()</code> call returns a <code>List&lt;ConfigurationData&gt;</code> which is the object representation of a configuration file. We can see that it's extracted configurations for 5 objects from our single model, we'll look at those after we've written out the file.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [13]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-java"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="n">provenance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lrModel</span><span class="p">.</span><span class="na">getProvenance</span><span class="p">();</span>
<span class="kd">var</span><span class="w"> </span><span class="n">provConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ProvenanceUtil</span><span class="p">.</span><span class="na">extractConfiguration</span><span class="p">(</span><span class="n">provenance</span><span class="p">);</span>
<span class="n">provConfig</span><span class="p">.</span><span class="na">size</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt output_prompt">Out[13]:</div>
<div class="output_text output_subarea output_execute_result">
<pre>5</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The <code>ConfigurationManager</code> is the way we can generate a configuration file from the object representation.
We create a new <code>ConfigurationManager</code>, add the configuration we extracted from the provenance, and then write
it out to a new JSON file.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [14]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-java"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="n">outputFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"mnist-logistic-config.json"</span><span class="p">;</span>
<span class="kd">var</span><span class="w"> </span><span class="n">newCM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ConfigurationManager</span><span class="p">();</span>
<span class="n">newCM</span><span class="p">.</span><span class="na">addConfiguration</span><span class="p">(</span><span class="n">provConfig</span><span class="p">);</span>
<span class="n">newCM</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">File</span><span class="p">(</span><span class="n">outputFile</span><span class="p">),</span><span class="kc">true</span><span class="p">);</span>
<span class="n">String</span><span class="p">.</span><span class="na">join</span><span class="p">(</span><span class="s">"\n"</span><span class="p">,</span><span class="n">Files</span><span class="p">.</span><span class="na">readAllLines</span><span class="p">(</span><span class="n">Paths</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">outputFile</span><span class="p">)))</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt output_prompt">Out[14]:</div>
<div class="output_text output_subarea output_execute_result">
<pre>{
  "config" : {
    "components" : [ {
      "name" : "libsvmdatasource-1",
      "type" : "org.tribuo.datasource.LibSVMDataSource",
      "export" : "false",
      "import" : "false",
      "properties" : {
        "path" : "/Users/apocock/Development/Tribuo/tutorials/mnist",
        "maxFeatureID" : "780",
        "zeroIndexed" : "false",
        "outputFactory" : "labelfactory-4",
        "url" : "file:/Users/apocock/Development/Tribuo/tutorials/mnist"
      }
    }, {
      "name" : "linearsgdtrainer-0",
      "type" : "org.tribuo.classification.sgd.linear.LinearSGDTrainer",
      "export" : "false",
      "import" : "false",
      "properties" : {
        "seed" : "1",
        "minibatchSize" : "1",
        "shuffle" : "true",
        "epochs" : "2",
        "optimiser" : "adagrad-2",
        "objective" : "logmulticlass-3",
        "loggingInterval" : "10000"
      }
    }, {
      "name" : "adagrad-2",
      "type" : "org.tribuo.math.optimisers.AdaGrad",
      "export" : "false",
      "import" : "false",
      "properties" : {
        "epsilon" : "0.01",
        "initialLearningRate" : "0.5",
        "initialValue" : "0.0"
      }
    }, {
      "name" : "labelfactory-4",
      "type" : "org.tribuo.classification.LabelFactory",
      "export" : "false",
      "import" : "false"
    }, {
      "name" : "logmulticlass-3",
      "type" : "org.tribuo.classification.sgd.objectives.LogMulticlass",
      "export" : "false",
      "import" : "false"
    } ]
  }
}</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The five elements of the configuration are: the training data "libsvmdatasource-1", the logistic regression "linearsgdtrainer-0", the training log loss function "logmulticlass-3", the AdaGrad gradient optimizer "adagrad-2", and the label factory "labelfactory-4". The only unexpected part is the <code>LabelFactory</code> which is the factory that converts <code>String</code>s into <code>Label</code> instances.</p>
<h2 id="Rebuilding-a-model-from-it's-configuration">Rebuilding a model from it's configuration<a class="anchor-link" href="#Rebuilding-a-model-from-it's-configuration">¶</a></h2><p>Now to reconstruct our model, we can load in the Trainer and DataSource from the new <code>ConfigurationManager</code>, pass the source into a <code>Dataset</code>, and finally call train on the new trainer supplying the new dataset.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [15]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-java"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="n">newTrainer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Trainer</span><span class="o">&lt;</span><span class="n">Label</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="n">newCM</span><span class="p">.</span><span class="na">lookup</span><span class="p">(</span><span class="s">"linearsgdtrainer-0"</span><span class="p">);</span>
<span class="kd">var</span><span class="w"> </span><span class="n">newSource</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">DataSource</span><span class="o">&lt;</span><span class="n">Label</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="n">newCM</span><span class="p">.</span><span class="na">lookup</span><span class="p">(</span><span class="s">"libsvmdatasource-1"</span><span class="p">);</span>
<span class="kd">var</span><span class="w"> </span><span class="n">newDataset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MutableDataset</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">newSource</span><span class="p">);</span>
<span class="kd">var</span><span class="w"> </span><span class="n">newModel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newTrainer</span><span class="p">.</span><span class="na">train</span><span class="p">(</span><span class="n">newDataset</span><span class="p">,</span><span class="w"> </span><span class="n">Collections</span><span class="p">.</span><span class="na">singletonMap</span><span class="p">(</span><span class="s">"reconfigured-model"</span><span class="p">,</span><span class="k">new</span><span class="w"> </span><span class="n">BooleanProvenance</span><span class="p">(</span><span class="s">"reconfigured-model"</span><span class="p">,</span><span class="kc">true</span><span class="p">)));</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>First we'll confirm that the old model and new models aren't equal (as they have different timestamps, among other provenance checks).</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [16]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-java"><pre><span></span><span class="n">lrModel</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">newModel</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt output_prompt">Out[16]:</div>
<div class="output_text output_subarea output_execute_result">
<pre>false</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now we'll evaluate the first model:</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [17]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-java"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="n">lrEvaluator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">evaluator</span><span class="p">.</span><span class="na">evaluate</span><span class="p">(</span><span class="n">lrModel</span><span class="p">,</span><span class="n">testData</span><span class="p">);</span>
<span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">lrEvaluator</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span>
<span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">lrEvaluator</span><span class="p">.</span><span class="na">getConfusionMatrix</span><span class="p">().</span><span class="na">toString</span><span class="p">());</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>Class                           n          tp          fn          fp      recall        prec          f1
0                             980         904          76          21       0.922       0.977       0.922
1                           1,135       1,072          63          18       0.944       0.983       0.944
2                           1,032         856         176          56       0.829       0.939       0.829
3                           1,010         844         166          84       0.836       0.909       0.836
4                             982         888          94          72       0.904       0.925       0.904
5                             892         751         141         143       0.842       0.840       0.842
6                             958         938          20         139       0.979       0.871       0.979
7                           1,028         963          65         133       0.937       0.879       0.937
8                             974         892          82         363       0.916       0.711       0.916
9                           1,009         801         208          62       0.794       0.928       0.794
Total                      10,000       8,909       1,091       1,091
Accuracy                                                                    0.891
Micro Average                                                               0.891       0.891       0.891
Macro Average                                                               0.890       0.896       0.890
Balanced Error Rate                                                         0.110
               0       1       2       3       4       5       6       7       8       9
0            904       0       2       3       1      20      26       4      18       2
1              0   1,072       7       3       0       2       6       2      43       0
2              3       6     856      26       5       7      39       8      80       2
3              1       0      13     844       2      64       7      14      62       3
4              0       0       7       2     888       1      22      15      20      27
5              9       1       1      27       6     751      18       7      68       4
6              3       1       2       1       1       9     938       1       2       0
7              1       5      18       6       4       1       0     963       9      21
8              1       3       6       9       9      25      20       6     892       3
9              3       2       0       7      44      14       1      76      61     801

</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>It's about what we'd expect for a linear model on MNIST. Not SOTA, but it'll do for now.</p>
<p>Now let's check the new model:</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [18]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-java"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="n">newEvaluator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">evaluator</span><span class="p">.</span><span class="na">evaluate</span><span class="p">(</span><span class="n">newModel</span><span class="p">,</span><span class="n">testData</span><span class="p">);</span>
<span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">newEvaluator</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span>
<span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">newEvaluator</span><span class="p">.</span><span class="na">getConfusionMatrix</span><span class="p">().</span><span class="na">toString</span><span class="p">());</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>Class                           n          tp          fn          fp      recall        prec          f1
0                             980         904          76          21       0.922       0.977       0.922
1                           1,135       1,072          63          18       0.944       0.983       0.944
2                           1,032         856         176          56       0.829       0.939       0.829
3                           1,010         844         166          84       0.836       0.909       0.836
4                             982         888          94          72       0.904       0.925       0.904
5                             892         751         141         143       0.842       0.840       0.842
6                             958         938          20         139       0.979       0.871       0.979
7                           1,028         963          65         133       0.937       0.879       0.937
8                             974         892          82         363       0.916       0.711       0.916
9                           1,009         801         208          62       0.794       0.928       0.794
Total                      10,000       8,909       1,091       1,091
Accuracy                                                                    0.891
Micro Average                                                               0.891       0.891       0.891
Macro Average                                                               0.890       0.896       0.890
Balanced Error Rate                                                         0.110
               0       1       2       3       4       5       6       7       8       9
0            904       0       2       3       1      20      26       4      18       2
1              0   1,072       7       3       0       2       6       2      43       0
2              3       6     856      26       5       7      39       8      80       2
3              1       0      13     844       2      64       7      14      62       3
4              0       0       7       2     888       1      22      15      20      27
5              9       1       1      27       6     751      18       7      68       4
6              3       1       2       1       1       9     938       1       2       0
7              1       5      18       6       4       1       0     963       9      21
8              1       3       6       9       9      25      20       6     892       3
9              3       2       0       7      44      14       1      76      61     801

</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We can see that both models perform identically. This is because our provenance system records the RNG seeds used at all points, and Tribuo is scrupulous about how and when it uses PRNGs. If you find a model reconstruction that gives a different answer (unless you're using XGBoost, which has some non-determinism beyond our control) then file an issue on our GitHub as that's a bug.</p>
<h2 id="What-else-lives-in-the-Provenance?">What else lives in the Provenance?<a class="anchor-link" href="#What-else-lives-in-the-Provenance?">¶</a></h2><p>These evaluations have provenance in the same way the models do, and we can use a pretty printer in OLCUT to make it a little more human readable.</p>
<p>In addition to the configuration information like the gradient optimiser and RNG seed, the provenance includes run specific information like the "reconfigured-model" flag we added, along with a hash of the data, timestamps for the various data files involved, and a timestamp for the model creation and dataset creation.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [19]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-java"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="n">evalProvenance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newEvaluator</span><span class="p">.</span><span class="na">getProvenance</span><span class="p">();</span>
<span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">ProvenanceUtil</span><span class="p">.</span><span class="na">formattedProvenanceString</span><span class="p">(</span><span class="n">evalProvenance</span><span class="p">));</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>EvaluationProvenance(
	class-name = org.tribuo.provenance.EvaluationProvenance
	model-provenance = LinearSGDModel(
			class-name = org.tribuo.classification.sgd.linear.LinearSGDModel
			dataset = MutableDataset(
					class-name = org.tribuo.MutableDataset
					datasource = LibSVMDataSource(
							class-name = org.tribuo.datasource.LibSVMDataSource
							path = /Users/apocock/Development/Tribuo/tutorials/mnist
							maxFeatureID = 780
							zeroIndexed = false
							outputFactory = LabelFactory(
									class-name = org.tribuo.classification.LabelFactory
								)
							url = file:/Users/apocock/Development/Tribuo/tutorials/mnist
							resource-hash = C42B75FCB54DDA11D97AF9BD6E3950B41C93B4F44EEB9608AA115F79A5979E88
							file-modified-time = 2020-07-06T10:52:01.776-04:00
							datasource-creation-time = 2020-07-21T13:28:11.674954-04:00
							host-short-name = DataSource
						)
					transformations = List[]
					is-sequence = false
					is-dense = false
					num-examples = 60000
					num-features = 717
					num-outputs = 10
					tribuo-version = 4.0.0-SNAPSHOT
				)
			trainer = LinearSGDTrainer(
					class-name = org.tribuo.classification.sgd.linear.LinearSGDTrainer
					seed = 1
					minibatchSize = 1
					shuffle = true
					epochs = 2
					optimiser = AdaGrad(
							class-name = org.tribuo.math.optimisers.AdaGrad
							epsilon = 0.01
							initialLearningRate = 0.5
							initialValue = 0.0
							host-short-name = StochasticGradientOptimiser
						)
					objective = LogMulticlass(
							class-name = org.tribuo.classification.sgd.objectives.LogMulticlass
							host-short-name = LabelObjective
						)
					loggingInterval = 10000
					train-invocation-count = 0
					is-sequence = false
					host-short-name = Trainer
				)
			trained-at = 2020-07-21T13:28:17.640344-04:00
			instance-values = Map{
			reconfigured-model=true
			}
			tribuo-version = 4.0.0-SNAPSHOT
		)
	dataset-provenance = MutableDataset(
			class-name = org.tribuo.MutableDataset
			datasource = LibSVMDataSource(
					class-name = org.tribuo.datasource.LibSVMDataSource
					path = /Users/apocock/Development/Tribuo/tutorials/mnist.t
					maxFeatureID = 778
					zeroIndexed = false
					outputFactory = LabelFactory(
							class-name = org.tribuo.classification.LabelFactory
						)
					url = file:/Users/apocock/Development/Tribuo/tutorials/mnist.t
					resource-hash = 31FFC3CFB1824D0994D57172BB8CA68882E578859E1EE1BD9FC1F2F15BFD06A2
					file-modified-time = 2020-07-06T10:52:01.888-04:00
					datasource-creation-time = 2020-07-21T13:28:01.871792-04:00
					host-short-name = DataSource
				)
			transformations = List[]
			is-sequence = false
			is-dense = false
			num-examples = 10000
			num-features = 668
			num-outputs = 10
			tribuo-version = 4.0.0-SNAPSHOT
		)
	tribuo-version = 4.0.0-SNAPSHOT
)
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Feature-Transformations">Feature Transformations<a class="anchor-link" href="#Feature-Transformations">¶</a></h2><p>We can take the new trainer, wrap it programmatically in a TransfomTrainer which rescales the input features into the range <code>[0,2]</code>, and still generate provenance and configuration automatically as the model is trained.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [20]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-java"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="n">transformations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TransformationMap</span><span class="p">(</span><span class="n">List</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">LinearScalingTransformation</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)));</span>
<span class="kd">var</span><span class="w"> </span><span class="n">transformed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TransformTrainer</span><span class="p">(</span><span class="n">newTrainer</span><span class="p">,</span><span class="n">transformations</span><span class="p">);</span>
<span class="kd">var</span><span class="w"> </span><span class="n">transformStart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">();</span>
<span class="kd">var</span><span class="w"> </span><span class="n">transformedModel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">transformed</span><span class="p">.</span><span class="na">train</span><span class="p">(</span><span class="n">newDataset</span><span class="p">);</span>
<span class="kd">var</span><span class="w"> </span><span class="n">transformEnd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">();</span>
<span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">"Training transformed logistic regression took "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Util</span><span class="p">.</span><span class="na">formatDuration</span><span class="p">(</span><span class="n">transformStart</span><span class="p">,</span><span class="n">transformEnd</span><span class="p">));</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>Training transformed logistic regression took (00:00:08:542)
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now we'll evaluate the rescaled model. Here we see that rescaling the data into the zero-one range improves the linear model performance a couple of percent as all the data is now on the same scale. As expected it's still not SOTA, but we're not using a huge CNN or some other complex model, for that you can try out our TensorFlow interface, or use the XGBoost trainer we loaded in from the original configuration file.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [21]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-java"><pre><span></span><span class="n">LabelEvaluation</span><span class="w"> </span><span class="n">transformedEvaluator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">evaluator</span><span class="p">.</span><span class="na">evaluate</span><span class="p">(</span><span class="n">transformedModel</span><span class="p">,</span><span class="n">testData</span><span class="p">);</span>
<span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">transformedEvaluator</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span>
<span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">transformedEvaluator</span><span class="p">.</span><span class="na">getConfusionMatrix</span><span class="p">().</span><span class="na">toString</span><span class="p">());</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>Class                           n          tp          fn          fp      recall        prec          f1
0                             980         957          23          40       0.977       0.960       0.977
1                           1,135       1,109          26          36       0.977       0.969       0.977
2                           1,032         940          92          90       0.911       0.913       0.911
3                           1,010         927          83         141       0.918       0.868       0.918
4                             982         914          68          73       0.931       0.926       0.931
5                             892         813          79         183       0.911       0.816       0.911
6                             958         892          66          45       0.931       0.952       0.931
7                           1,028         918         110          54       0.893       0.944       0.893
8                             974         753         221          60       0.773       0.926       0.773
9                           1,009         926          83         129       0.918       0.878       0.918
Total                      10,000       9,149         851         851
Accuracy                                                                    0.915
Micro Average                                                               0.915       0.915       0.915
Macro Average                                                               0.914       0.915       0.913
Balanced Error Rate                                                         0.086
               0       1       2       3       4       5       6       7       8       9
0            957       0       1       2       1      12       4       2       1       0
1              0   1,109      10       3       0       2       3       2       6       0
2              4       9     940      18       9       7      11      11      19       4
3              6       0      25     927       0      26       2       7       9       8
4              1       1       7       4     914       0       9       7       4      35
5              7       1       2      30       8     813       9       3      18       1
6              8       2      14       3       8      27     892       2       2       0
7              1       7      17      19       8       1       0     918       1      56
8              7       9      13      46      11      93       7      10     753      25
9              6       7       1      16      28      15       0      10       0     926

</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We can emit a configuration which includes both the transformation trainer and the original trainer pulled from the old configuration.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [22]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-java"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="n">transformedProvConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ProvenanceUtil</span><span class="p">.</span><span class="na">extractConfiguration</span><span class="p">(</span><span class="n">transformedModel</span><span class="p">.</span><span class="na">getProvenance</span><span class="p">());</span>
<span class="kd">var</span><span class="w"> </span><span class="n">transformedOutputFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"mnist-transformed-logistic-config.json"</span><span class="p">;</span>
<span class="n">newCM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ConfigurationManager</span><span class="p">();</span>
<span class="n">newCM</span><span class="p">.</span><span class="na">addConfiguration</span><span class="p">(</span><span class="n">transformedProvConfig</span><span class="p">);</span>
<span class="n">newCM</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">File</span><span class="p">(</span><span class="n">transformedOutputFile</span><span class="p">),</span><span class="kc">true</span><span class="p">);</span>
<span class="n">String</span><span class="p">.</span><span class="na">join</span><span class="p">(</span><span class="s">"\n"</span><span class="p">,</span><span class="n">Files</span><span class="p">.</span><span class="na">readAllLines</span><span class="p">(</span><span class="n">Paths</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">transformedOutputFile</span><span class="p">)))</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt output_prompt">Out[22]:</div>
<div class="output_text output_subarea output_execute_result">
<pre>{
  "config" : {
    "components" : [ {
      "name" : "linearscalingtransformation-4",
      "type" : "org.tribuo.transform.transformations.LinearScalingTransformation",
      "export" : "false",
      "import" : "false",
      "properties" : {
        "targetMax" : "1.0",
        "targetMin" : "0.0"
      }
    }, {
      "name" : "labelfactory-7",
      "type" : "org.tribuo.classification.LabelFactory",
      "export" : "false",
      "import" : "false"
    }, {
      "name" : "adagrad-5",
      "type" : "org.tribuo.math.optimisers.AdaGrad",
      "export" : "false",
      "import" : "false",
      "properties" : {
        "epsilon" : "0.01",
        "initialLearningRate" : "0.5",
        "initialValue" : "0.0"
      }
    }, {
      "name" : "linearsgdtrainer-2",
      "type" : "org.tribuo.classification.sgd.linear.LinearSGDTrainer",
      "export" : "false",
      "import" : "false",
      "properties" : {
        "seed" : "1",
        "minibatchSize" : "1",
        "shuffle" : "true",
        "epochs" : "2",
        "optimiser" : "adagrad-5",
        "objective" : "logmulticlass-6",
        "loggingInterval" : "10000"
      }
    }, {
      "name" : "transformtrainer-0",
      "type" : "org.tribuo.transform.TransformTrainer",
      "export" : "false",
      "import" : "false",
      "properties" : {
        "transformations" : "transformationmap-1",
        "densify" : "false",
        "innerTrainer" : "linearsgdtrainer-2"
      }
    }, {
      "name" : "logmulticlass-6",
      "type" : "org.tribuo.classification.sgd.objectives.LogMulticlass",
      "export" : "false",
      "import" : "false"
    }, {
      "name" : "libsvmdatasource-3",
      "type" : "org.tribuo.datasource.LibSVMDataSource",
      "export" : "false",
      "import" : "false",
      "properties" : {
        "path" : "/Users/apocock/Development/Tribuo/tutorials/mnist",
        "maxFeatureID" : "780",
        "zeroIndexed" : "false",
        "outputFactory" : "labelfactory-7",
        "url" : "file:/Users/apocock/Development/Tribuo/tutorials/mnist"
      }
    }, {
      "name" : "transformationmap-1",
      "type" : "org.tribuo.transform.TransformationMap",
      "export" : "false",
      "import" : "false",
      "properties" : {
        "featureTransformationList" : { },
        "globalTransformations" : [ {
          "item" : "linearscalingtransformation-4"
        } ]
      }
    } ]
  }
}</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Aside from the names (which have different tag numbers) we can see that this configuration is identical to the previous one, but with the addition of the <code>transformtrainer-0</code> and it's dependents.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Conclusion">Conclusion<a class="anchor-link" href="#Conclusion">¶</a></h2><p>We've taken a closer look at Tribuo's configuration and provenance systems, showing how to train a model using a configuration file, how to inspect the model's provenance, extract it's configuration, and finally how to combine that extracted configuration with other programmatic elements of the Tribuo library (in this case the feature transformation system). We saw that the provenance combines both the configuration of the trainer and the datasource, along with runtime information extracted from the dataset itself (e.g. timestamps and file hashes).</p>
<p>Tribuo's configuration system is integrated into a CLI options/arguments parsing system, which can be used to override elements from the configuration file. The values from the options are then stored in the <code>ConfigurationManager</code> and appear in the provenance and downstream configuration objects as expected. Tribuo also provides a redaction system for configuration files (e.g. to ensure a password isn't stored in the provenance) and for provenance objects themselves (e.g. to remove the data provenance from a trained model), which aids model deployment to untrusted or less trusted systems.</p>
</div>
</div>
</div>
</div>
</div>
</main>
