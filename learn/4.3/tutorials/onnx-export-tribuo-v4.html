---
title: "ONNX export and OCI deployment"
og-title: "ONNX export and OCI deployment Tutorial"
learn_nav: true
parent: Tutorials
nav_order: 310
is_notebook: true
notebook_url: https://github.com/oracle/tribuo/blob/main/tutorials/onnx-export-tribuo-v4.ipynb
comment: ## DO NOT EDIT THIS FILE. IT IS COPIED FROM THE TRIBUO DOC. EDIT IT THERE. ##
---
    <div class="container" id="notebook-container">

<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Model-export-and-deployment-tutorial">Model export and deployment tutorial<a class="anchor-link" href="#Model-export-and-deployment-tutorial">&#182;</a></h1><p>Tribuo works best as a library which provides training and deployment inside the JVM where the application is running, however sometimes you need to deploy models elsewhere, either in another programming environment like Python, or in a cloud service. To support these use cases many of Tribuo's models can be exported as <a href="https://onnx.ai">ONNX</a> models, a cross-platform model exchange format. ONNX is widely supported across industry, for edge devices, hardware accelerators, and cloud services. Tribuo also supports loading in ONNX models and scoring them as native Tribuo models, for more information on that see the external models tutorial.</p>
<p>This tutorial will show how to export models in ONNX format, how to recover the provenance information from Tribuo-exported ONNX models, and how to deploy an ONNX model in <a href="https://www.oracle.com/data-science/cloud-infrastructure-data-science.html">OCI Data Science</a> though of course other cloud providers support ONNX models too. We'll show how to export a factorization machine, create an ensemble of a factorization machine along with some other models, export the ensemble, then we'll discuss how to interact with the provenance of an exported model, before concluding with deploying that model to OCI.</p>
<h2 id="Setup">Setup<a class="anchor-link" href="#Setup">&#182;</a></h2><p>This tutorial requires ONNX Runtime to score the exported models, so by default will only run on x86_64 platforms. ONNX Runtime can be compiled on ARM64 platforms, but that binary is not in the Maven Central jar Tribuo depends on, so will need to be compiled from scratch to run the tutorial on ARM.</p>
<p>We're going to use MNIST as the example dataset for this tutorial, so you'll need to download it if you haven't already.</p>
<p>First the training set:</p>
<p><code>wget http://yann.lecun.com/exdb/mnist/train-images-idx3-ubyte.gz</code></p>
<p><code>wget http://yann.lecun.com/exdb/mnist/train-labels-idx1-ubyte.gz</code></p>
<p>Then the test set:</p>
<p><code>wget http://yann.lecun.com/exdb/mnist/t10k-images-idx3-ubyte.gz</code></p>
<p><code>wget http://yann.lecun.com/exdb/mnist/t10k-labels-idx1-ubyte.gz</code></p>
<p>As usual we'll load in some jars for classification problems, along with Tribuo's ONNX Runtime and OCI interfaces.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[1]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-java"><pre><span></span><span class="o">%</span><span class="n">jars</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">tribuo</span><span class="o">-</span><span class="n">classification</span><span class="o">-</span><span class="n">experiments</span><span class="o">-</span><span class="mf">4.3.0</span><span class="o">-</span><span class="n">jar</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">dependencies</span><span class="p">.</span><span class="na">jar</span><span class="w"></span>
<span class="o">%</span><span class="n">jars</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">tribuo</span><span class="o">-</span><span class="n">oci</span><span class="o">-</span><span class="mf">4.3.0</span><span class="o">-</span><span class="n">jar</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">dependencies</span><span class="p">.</span><span class="na">jar</span><span class="w"></span>
<span class="o">%</span><span class="n">jars</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">tribuo</span><span class="o">-</span><span class="n">onnx</span><span class="o">-</span><span class="mf">4.3.0</span><span class="o">-</span><span class="n">jar</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">dependencies</span><span class="p">.</span><span class="na">jar</span><span class="w"></span>
<span class="o">%</span><span class="n">jars</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">tribuo</span><span class="o">-</span><span class="n">json</span><span class="o">-</span><span class="mf">4.3.0</span><span class="o">-</span><span class="n">jar</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">dependencies</span><span class="p">.</span><span class="na">jar</span><span class="w"></span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[2]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-java"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.nio.file.Files</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.nio.file.Paths</span><span class="p">;</span><span class="w"></span>

<span class="kn">import</span><span class="w"> </span><span class="nn">org.tribuo.*</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.tribuo.classification.*</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.tribuo.classification.ensemble.*</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.tribuo.classification.evaluation.*</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.tribuo.classification.sgd.fm.FMClassificationTrainer</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.tribuo.classification.sgd.linear.*</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.tribuo.classification.sgd.objectives.LogMulticlass</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.tribuo.ensemble.*</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.tribuo.data.csv.CSVLoader</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.tribuo.datasource.IDXDataSource</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.tribuo.evaluation.TrainTestSplitter</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.tribuo.interop.onnx.*</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.tribuo.math.optimisers.*</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.tribuo.interop.oci.*</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.tribuo.util.onnx.*</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.tribuo.util.Util</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.oracle.bmc.ConfigFileReader</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.oracle.bmc.auth.ConfigFileAuthenticationDetailsProvider</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.oracle.bmc.datascience.DataScienceClient</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.oracle.labs.mlrg.olcut.provenance.ProvenanceUtil</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.oracle.labs.mlrg.olcut.util.Pair</span><span class="p">;</span><span class="w"></span>

<span class="kn">import</span><span class="w"> </span><span class="nn">ai.onnxruntime.*</span><span class="p">;</span><span class="w"></span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Then we'll load in MNIST and Wine Quality.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[3]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-java"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="n">labelFactory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">LabelFactory</span><span class="p">();</span><span class="w"></span>
<span class="kd">var</span><span class="w"> </span><span class="n">labelEvaluator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">LabelEvaluator</span><span class="p">();</span><span class="w"></span>
<span class="kd">var</span><span class="w"> </span><span class="n">mnistTrainSource</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IDXDataSource</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">Paths</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;train-images-idx3-ubyte.gz&quot;</span><span class="p">),</span><span class="n">Paths</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;train-labels-idx1-ubyte.gz&quot;</span><span class="p">),</span><span class="n">labelFactory</span><span class="p">);</span><span class="w"></span>
<span class="kd">var</span><span class="w"> </span><span class="n">mnistTestSource</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IDXDataSource</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">Paths</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;t10k-images-idx3-ubyte.gz&quot;</span><span class="p">),</span><span class="n">Paths</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;t10k-labels-idx1-ubyte.gz&quot;</span><span class="p">),</span><span class="n">labelFactory</span><span class="p">);</span><span class="w"></span>
<span class="kd">var</span><span class="w"> </span><span class="n">mnistTrain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MutableDataset</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">mnistTrainSource</span><span class="p">);</span><span class="w"></span>
<span class="kd">var</span><span class="w"> </span><span class="n">mnistTest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MutableDataset</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">mnistTestSource</span><span class="p">);</span><span class="w"></span>
<span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="s">&quot;MNIST train size = %d, number of features = %d, number of classes = %d&quot;</span><span class="p">,</span><span class="n">mnistTrain</span><span class="p">.</span><span class="na">size</span><span class="p">(),</span><span class="n">mnistTrain</span><span class="p">.</span><span class="na">getFeatureMap</span><span class="p">().</span><span class="na">size</span><span class="p">(),</span><span class="n">mnistTrain</span><span class="p">.</span><span class="na">getOutputInfo</span><span class="p">().</span><span class="na">size</span><span class="p">()));</span><span class="w"></span>
<span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="s">&quot;MNIST test size = %d, number of features = %d, number of classes = %d&quot;</span><span class="p">,</span><span class="n">mnistTest</span><span class="p">.</span><span class="na">size</span><span class="p">(),</span><span class="n">mnistTest</span><span class="p">.</span><span class="na">getFeatureMap</span><span class="p">().</span><span class="na">size</span><span class="p">(),</span><span class="n">mnistTest</span><span class="p">.</span><span class="na">getOutputInfo</span><span class="p">().</span><span class="na">size</span><span class="p">()));</span><span class="w"></span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>MNIST train size = 60000, number of features = 717, number of classes = 10
MNIST test size = 10000, number of features = 668, number of classes = 10
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Exporting-a-single-classification-model">Exporting a single classification model<a class="anchor-link" href="#Exporting-a-single-classification-model">&#182;</a></h2><p>We're going to train a multi-class <a href="https://ieeexplore.ieee.org/document/5694074">Factorization Machine</a>, which is a non-linear model that approximates all the non-linear feature interactions with a small per-feature embedding vector. It's similar to a logistic regression with an additional feature-feature interaction term, one per output label. In Tribuo Factorization Machines can be trained using stochastic gradient descent, using the standard SGD algorithms Tribuo uses for other models. We're going to use AdaGrad as it's usually a good baseline.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[4]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-java"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="n">fmLabelTrainer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FMClassificationTrainer</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">LogMulticlass</span><span class="p">(),</span><span class="w">  </span><span class="c1">// Loss function</span><span class="w"></span>
<span class="w">                                                 </span><span class="k">new</span><span class="w"> </span><span class="n">AdaGrad</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">0.1</span><span class="p">),</span><span class="w"> </span><span class="c1">// Gradient optimiser</span><span class="w"></span>
<span class="w">                                                 </span><span class="mi">5</span><span class="p">,</span><span class="w">                    </span><span class="c1">// Number of training epochs</span><span class="w"></span>
<span class="w">                                                 </span><span class="mi">30000</span><span class="p">,</span><span class="w">                </span><span class="c1">// Logging interval</span><span class="w"></span>
<span class="w">                                                 </span><span class="n">Trainer</span><span class="p">.</span><span class="na">DEFAULT_SEED</span><span class="p">,</span><span class="w"> </span><span class="c1">// RNG seed</span><span class="w"></span>
<span class="w">                                                 </span><span class="mi">6</span><span class="p">,</span><span class="w">                    </span><span class="c1">// Factor size</span><span class="w"></span>
<span class="w">                                                 </span><span class="mf">0.1</span><span class="w">                   </span><span class="c1">// Factor initialisation variance</span><span class="w"></span>
<span class="w">                                                 </span><span class="p">);</span><span class="w"></span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>After defining the model we train it as usual. Factorization machines take a little longer to train than logistic regression does, but not excessively so.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[5]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-java"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="n">fmStartTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">();</span><span class="w"></span>
<span class="kd">var</span><span class="w"> </span><span class="n">fmMNIST</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fmLabelTrainer</span><span class="p">.</span><span class="na">train</span><span class="p">(</span><span class="n">mnistTrain</span><span class="p">);</span><span class="w"></span>
<span class="kd">var</span><span class="w"> </span><span class="n">fmEndTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">();</span><span class="w"></span>
<span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Training factorization machine took &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Util</span><span class="p">.</span><span class="na">formatDuration</span><span class="p">(</span><span class="n">fmStartTime</span><span class="p">,</span><span class="n">fmEndTime</span><span class="p">));</span><span class="w"></span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>Training factorization machine took (00:00:15:126)
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>And then evaluate it using Tribuo's built in evaluation system.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[6]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-java"><pre><span></span><span class="n">fmStartTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">();</span><span class="w"></span>
<span class="kd">var</span><span class="w"> </span><span class="n">mnistFMEval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">labelEvaluator</span><span class="p">.</span><span class="na">evaluate</span><span class="p">(</span><span class="n">fmMNIST</span><span class="p">,</span><span class="n">mnistTest</span><span class="p">);</span><span class="w"></span>
<span class="n">fmEndTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">();</span><span class="w"></span>
<span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Scoring factorization machine took &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Util</span><span class="p">.</span><span class="na">formatDuration</span><span class="p">(</span><span class="n">fmStartTime</span><span class="p">,</span><span class="n">fmEndTime</span><span class="p">));</span><span class="w"></span>
<span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">mnistFMEval</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span><span class="w"></span>
<span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">mnistFMEval</span><span class="p">.</span><span class="na">getConfusionMatrix</span><span class="p">().</span><span class="na">toString</span><span class="p">());</span><span class="w"></span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>Scoring factorization machine took (00:00:00:379)
Class                           n          tp          fn          fp      recall        prec          f1
0                             980         959          21          31       0.979       0.969       0.974
1                           1,135       1,120          15          22       0.987       0.981       0.984
2                           1,032         976          56          57       0.946       0.945       0.945
3                           1,010         952          58          39       0.943       0.961       0.952
4                             982         952          30          49       0.969       0.951       0.960
5                             892         857          35          63       0.961       0.932       0.946
6                             958         920          38          30       0.960       0.968       0.964
7                           1,028         969          59          36       0.943       0.964       0.953
8                             974         916          58          57       0.940       0.941       0.941
9                           1,009         951          58          44       0.943       0.956       0.949
Total                      10,000       9,572         428         428
Accuracy                                                                    0.957
Micro Average                                                               0.957       0.957       0.957
Macro Average                                                               0.957       0.957       0.957
Balanced Error Rate                                                         0.043
               0       1       2       3       4       5       6       7       8       9
0            959       0       0       0       1       2       7       4       4       3
1              0   1,120       4       1       3       0       3       0       4       0
2              6       5     976       7       7       2       5       8      14       2
3              0       2      15     952       0      19       1       3      14       4
4              3       3       7       1     952       0       4       1       1      10
5              3       1       0       6       1     857       5       5      13       1
6              8       2       7       2       7      11     920       1       0       0
7              2       5      13       5       4       4       0     969       4      22
8              2       1       9       9      11      15       4       5     916       2
9              7       3       2       8      15      10       1       9       3     951

</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We get about 95% accuracy on MNIST, which is pretty good for a fairly simple model. Now let's export it to ONNX, then  we'll load it back in via Tribuo's ONNX Runtime interface and compare the performance. We'll use this model in the reproducibility tutorial so we'll save it to disk in the tutorials folder.</p>
<p>Tribuo <code>Model</code>s which support ONNX export implement the <code>ONNXExportable</code> interface which defines methods for constructing an ONNX protobuf and saving it to disk.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[7]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-java"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="n">fmMNISTPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Paths</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">,</span><span class="s">&quot;fm-mnist.onnx&quot;</span><span class="p">);</span><span class="w"></span>
<span class="n">fmMNIST</span><span class="p">.</span><span class="na">saveONNXModel</span><span class="p">(</span><span class="s">&quot;org.tribuo.tutorials.onnxexport.fm&quot;</span><span class="p">,</span><span class="w"> </span><span class="c1">// namespace for the model</span><span class="w"></span>
<span class="w">                      </span><span class="mi">0</span><span class="p">,</span><span class="w">                                    </span><span class="c1">// model version number</span><span class="w"></span>
<span class="w">                      </span><span class="n">fmMNISTPath</span><span class="w">                           </span><span class="c1">// path to save the model</span><span class="w"></span>
<span class="w">                      </span><span class="p">);</span><span class="w"></span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>To load an ONNX model we need to define the mapping between Tribuo's feature names and the indices that the ONNX model understands. Fortunately for models exported from Tribuo we already have that information, as it is stored in the feature and output maps. We'll extract it into the general form that <code>ONNXExternalModel</code> expects.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[8]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-java"><pre><span></span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">mnistFeatureMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w"></span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">VariableInfo</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">fmMNIST</span><span class="p">.</span><span class="na">getFeatureIDMap</span><span class="p">()){</span><span class="w"></span>
<span class="w">    </span><span class="n">VariableIDInfo</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">VariableIDInfo</span><span class="p">)</span><span class="w"> </span><span class="n">f</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">mnistFeatureMap</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">id</span><span class="p">.</span><span class="na">getName</span><span class="p">(),</span><span class="n">id</span><span class="p">.</span><span class="na">getID</span><span class="p">());</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="n">Map</span><span class="o">&lt;</span><span class="n">Label</span><span class="p">,</span><span class="w"> </span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">mnistOutputMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w"></span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Pair</span><span class="o">&lt;</span><span class="n">Integer</span><span class="p">,</span><span class="n">Label</span><span class="o">&gt;</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">fmMNIST</span><span class="p">.</span><span class="na">getOutputIDInfo</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">mnistOutputMap</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">l</span><span class="p">.</span><span class="na">getB</span><span class="p">(),</span><span class="w"> </span><span class="n">l</span><span class="p">.</span><span class="na">getA</span><span class="p">());</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now we'll define a test function that compares two sets of predictions, as ONNX Runtime uses single precision for computations, and Tribuo uses double precision so the prediction scores are never bitwise equal.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[9]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-java"><pre><span></span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">checkPredictions</span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Prediction</span><span class="o">&lt;</span><span class="n">Label</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">nativePredictions</span><span class="p">,</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Prediction</span><span class="o">&lt;</span><span class="n">Label</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">onnxPredictions</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">delta</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">nativePredictions</span><span class="p">.</span><span class="na">size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Prediction</span><span class="o">&lt;</span><span class="n">Label</span><span class="o">&gt;</span><span class="w"> </span><span class="n">tribuo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nativePredictions</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">i</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Prediction</span><span class="o">&lt;</span><span class="n">Label</span><span class="o">&gt;</span><span class="w"> </span><span class="n">external</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">onnxPredictions</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">i</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="c1">// Check the predicted label</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">tribuo</span><span class="p">.</span><span class="na">getOutput</span><span class="p">().</span><span class="na">getLabel</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span><span class="n">external</span><span class="p">.</span><span class="na">getOutput</span><span class="p">().</span><span class="na">getLabel</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;At index &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; predictions are not equal - &quot;</span><span class="w"></span>
<span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="n">tribuo</span><span class="p">.</span><span class="na">getOutput</span><span class="p">().</span><span class="na">getLabel</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; and &quot;</span><span class="w"></span>
<span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="n">external</span><span class="p">.</span><span class="na">getOutput</span><span class="p">().</span><span class="na">getLabel</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="c1">// Check the maximum score</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Math</span><span class="p">.</span><span class="na">abs</span><span class="p">(</span><span class="n">tribuo</span><span class="p">.</span><span class="na">getOutput</span><span class="p">().</span><span class="na">getScore</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">external</span><span class="p">.</span><span class="na">getOutput</span><span class="p">().</span><span class="na">getScore</span><span class="p">())</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">delta</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;At index &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; predictions are not equal - &quot;</span><span class="w"></span>
<span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="n">tribuo</span><span class="p">.</span><span class="na">getOutput</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; and &quot;</span><span class="w"></span>
<span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="n">external</span><span class="p">.</span><span class="na">getOutput</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="c1">// Check the score distribution</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Map</span><span class="p">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Label</span><span class="o">&gt;</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">tribuo</span><span class="p">.</span><span class="na">getOutputScores</span><span class="p">().</span><span class="na">entrySet</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">Label</span><span class="w"> </span><span class="n">other</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">external</span><span class="p">.</span><span class="na">getOutputScores</span><span class="p">().</span><span class="na">get</span><span class="p">(</span><span class="n">l</span><span class="p">.</span><span class="na">getKey</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">other</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;At index &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; failed to find label &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">l</span><span class="p">.</span><span class="na">getKey</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; in ORT prediction.&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Math</span><span class="p">.</span><span class="na">abs</span><span class="p">(</span><span class="n">l</span><span class="p">.</span><span class="na">getValue</span><span class="p">().</span><span class="na">getScore</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">other</span><span class="p">.</span><span class="na">getScore</span><span class="p">())</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">delta</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;At index &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; predictions are not equal - &quot;</span><span class="w"></span>
<span class="w">                            </span><span class="o">+</span><span class="w"> </span><span class="n">tribuo</span><span class="p">.</span><span class="na">getOutputScores</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; and &quot;</span><span class="w"></span>
<span class="w">                            </span><span class="o">+</span><span class="w"> </span><span class="n">external</span><span class="p">.</span><span class="na">getOutputScores</span><span class="p">());</span><span class="w"></span>
<span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Then we'll construct the <code>ONNXExternalModel</code> loading our freshly created ONNX model using the feature and output mappings we built earlier. First we create a <code>SessionOptions</code> which controls the model inference. By default it uses a single thread on one CPU, but by setting values in the options object before building the external model we can make it run on multiple threads, use GPUs or other accelerator hardware supported by ONNX Runtime.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[10]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-java"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="n">ortEnv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OrtEnvironment</span><span class="p">.</span><span class="na">getEnvironment</span><span class="p">();</span><span class="w"></span>
<span class="kd">var</span><span class="w"> </span><span class="n">sessionOpts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">OrtSession</span><span class="p">.</span><span class="na">SessionOptions</span><span class="p">();</span><span class="w"></span>
<span class="kd">var</span><span class="w"> </span><span class="n">denseTransformer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DenseTransformer</span><span class="p">();</span><span class="w"></span>
<span class="kd">var</span><span class="w"> </span><span class="n">labelTransformer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">LabelTransformer</span><span class="p">();</span><span class="w"></span>
<span class="n">ONNXExternalModel</span><span class="o">&lt;</span><span class="n">Label</span><span class="o">&gt;</span><span class="w"> </span><span class="n">onnxFM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ONNXExternalModel</span><span class="p">.</span><span class="na">createOnnxModel</span><span class="p">(</span><span class="n">labelFactory</span><span class="p">,</span><span class="w"> </span><span class="n">mnistFeatureMap</span><span class="p">,</span><span class="w"> </span><span class="n">mnistOutputMap</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="n">denseTransformer</span><span class="p">,</span><span class="w"> </span><span class="n">labelTransformer</span><span class="p">,</span><span class="w"> </span><span class="n">sessionOpts</span><span class="p">,</span><span class="w"> </span><span class="n">fmMNISTPath</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;input&quot;</span><span class="p">);</span><span class="w"></span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>An <code>ONNXExternalModel</code> is a Tribuo model so we can use the same evaluation infrastructure.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[11]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-java"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="n">onnxStartTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">();</span><span class="w"></span>
<span class="kd">var</span><span class="w"> </span><span class="n">mnistONNXEval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">labelEvaluator</span><span class="p">.</span><span class="na">evaluate</span><span class="p">(</span><span class="n">onnxFM</span><span class="p">,</span><span class="n">mnistTest</span><span class="p">);</span><span class="w"></span>
<span class="kd">var</span><span class="w"> </span><span class="n">onnxEndTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">();</span><span class="w"></span>
<span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Scoring ONNX factorization machine took &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Util</span><span class="p">.</span><span class="na">formatDuration</span><span class="p">(</span><span class="n">onnxStartTime</span><span class="p">,</span><span class="n">onnxEndTime</span><span class="p">));</span><span class="w"></span>
<span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">mnistONNXEval</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span><span class="w"></span>
<span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">mnistONNXEval</span><span class="p">.</span><span class="na">getConfusionMatrix</span><span class="p">().</span><span class="na">toString</span><span class="p">());</span><span class="w"></span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>Scoring ONNX factorization machine took (00:00:00:801)
Class                           n          tp          fn          fp      recall        prec          f1
0                             980         959          21          31       0.979       0.969       0.974
1                           1,135       1,120          15          22       0.987       0.981       0.984
2                           1,032         976          56          57       0.946       0.945       0.945
3                           1,010         952          58          39       0.943       0.961       0.952
4                             982         952          30          49       0.969       0.951       0.960
5                             892         857          35          63       0.961       0.932       0.946
6                             958         920          38          30       0.960       0.968       0.964
7                           1,028         969          59          36       0.943       0.964       0.953
8                             974         916          58          57       0.940       0.941       0.941
9                           1,009         951          58          44       0.943       0.956       0.949
Total                      10,000       9,572         428         428
Accuracy                                                                    0.957
Micro Average                                                               0.957       0.957       0.957
Macro Average                                                               0.957       0.957       0.957
Balanced Error Rate                                                         0.043
               0       1       2       3       4       5       6       7       8       9
0            959       0       0       0       1       2       7       4       4       3
1              0   1,120       4       1       3       0       3       0       4       0
2              6       5     976       7       7       2       5       8      14       2
3              0       2      15     952       0      19       1       3      14       4
4              3       3       7       1     952       0       4       1       1      10
5              3       1       0       6       1     857       5       5      13       1
6              8       2       7       2       7      11     920       1       0       0
7              2       5      13       5       4       4       0     969       4      22
8              2       1       9       9      11      15       4       5     916       2
9              7       3       2       8      15      10       1       9       3     951

</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The two models evaluate the same, but they could be producing slightly different probability values, so let's check it using our more precise comparsion function. <code>checkPrediction</code> will log any divergence it finds, as well as returning true or false if the predictions differ. We're going to use a delta of 1e-5, and consider differences below that threshold to be irrelevant.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[12]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-java"><pre><span></span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Predictions are equal - &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="w">                    </span><span class="n">checkPredictions</span><span class="p">(</span><span class="n">mnistFMEval</span><span class="p">.</span><span class="na">getPredictions</span><span class="p">(),</span><span class="w"> </span><span class="n">mnistONNXEval</span><span class="p">.</span><span class="na">getPredictions</span><span class="p">(),</span><span class="w"> </span><span class="mf">1e-5</span><span class="p">));</span><span class="w"></span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>Predictions are equal - true
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>An important part of a Tribuo model is the provenance. We don't want to lose that information when exporting models to ONNX format, so we encode the provenance in the ONNX protobuf. It uses the marshalled provenance format from OLCUT, and the protos are available in OLCUT so they could be parsed in other systems. As a result when loading in a Tribuo-exported ONNX model the <code>ONNXExternalModel</code> class has two provenance objects, one for the <code>ONNXExternalModel</code> itself, and one for the original <code>Model</code> object.</p>
<p>Let's examine both of these provenances. First the one for the <code>ONNXExternalModel</code>:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[13]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-java"><pre><span></span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;ONNXExternalModel provenance:\n&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ProvenanceUtil</span><span class="p">.</span><span class="na">formattedProvenanceString</span><span class="p">(</span><span class="n">onnxFM</span><span class="p">.</span><span class="na">getProvenance</span><span class="p">()));</span><span class="w"></span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>ONNXExternalModel provenance:
ONNXExternalModel(
	class-name = org.tribuo.interop.onnx.ONNXExternalModel
	dataset = Dataset(
			class-name = org.tribuo.Dataset
			datasource = DataSource(
					description = unknown-external-data
					outputFactory = LabelFactory(
							class-name = org.tribuo.classification.LabelFactory
						)
					datasource-creation-time = 2022-10-07T11:46:10.955196-04:00
				)
			transformations = List[]
			is-sequence = false
			is-dense = false
			num-examples = -1
			num-features = 717
			num-outputs = 10
			tribuo-version = 4.3.0
		)
	trainer = Trainer(
			class-name = org.tribuo.Trainer
			fileModifiedTime = 2022-10-07T11:46:10.476-04:00
			modelHash = 9DD2FABC436FB75BAD6A3E061BE51022A79F140FC491C6CA8B8033253F43CD5F
			location = file:/local/ExternalRepositories/tribuo/tutorials/./fm-mnist.onnx
		)
	trained-at = 2022-10-07T11:46:10.952607-04:00
	instance-values = Map{
		model-domain=org.tribuo.tutorials.onnxexport.fm
		model-graphname=FMClassificationModel
		model-description=factorization-machine-model - Model(class-name=org.tribuo.classification.sgd.fm.FMClassificationModel,dataset=Dataset(class-name=org.tribuo.MutableDataset,datasource=DataSource(class-name=org.tribuo.datasource.IDXDataSource,outputPath=/local/ExternalRepositories/tribuo/tutorials/train-labels-idx1-ubyte.gz,outputFactory=OutputFactory(class-name=org.tribuo.classification.LabelFactory),featuresPath=/local/ExternalRepositories/tribuo/tutorials/train-images-idx3-ubyte.gz,features-file-modified-time=2000-07-21T14:20:24-04:00,output-resource-hash=SHA-256[3552534A0A558BBED6AED32B30C495CCA23D567EC52CAC8BE1A0730E8010255C],datasource-creation-time=2022-10-07T11:45:53.253680-04:00,output-file-modified-time=2000-07-21T14:20:27-04:00,idx-feature-type=UBYTE,features-resource-hash=SHA-256[440FCABF73CC546FA21475E81EA370265605F56BE210A4024D2CA8F203523609],host-short-name=DataSource),transformations=[],is-sequence=false,is-dense=false,num-examples=60000,num-features=717,num-outputs=10,tribuo-version=4.3.0),trainer=Trainer(class-name=org.tribuo.classification.sgd.fm.FMClassificationTrainer,seed=12345,variance=0.1,minibatchSize=1,factorizedDimSize=6,shuffle=true,epochs=5,optimiser=StochasticGradientOptimiser(class-name=org.tribuo.math.optimisers.AdaGrad,epsilon=0.1,initialLearningRate=0.1,initialValue=0.0,host-short-name=StochasticGradientOptimiser),loggingInterval=30000,objective=LabelObjective(class-name=org.tribuo.classification.sgd.objectives.LogMulticlass,host-short-name=LabelObjective),tribuo-version=4.3.0,train-invocation-count=0,is-sequence=false,host-short-name=Trainer),trained-at=2022-10-07T11:46:09.759423-04:00,instance-values={},tribuo-version=4.3.0,java-version=12,os-name=Linux,os-arch=amd64)
		model-producer=Tribuo
		model-version=0
		input-name=input
	}
	tribuo-version = 4.3.0
	java-version = 12
	os-name = Linux
	os-arch = amd64
)
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This has the location the ONNX file was loaded from, a hash of the file, and timestamps for both the ONNX file and the model object wrapping it.</p>
<p>Now let's look at the original Model provenance:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[14]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-java"><pre><span></span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;ONNX file provenance:\n&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ProvenanceUtil</span><span class="p">.</span><span class="na">formattedProvenanceString</span><span class="p">(</span><span class="n">onnxFM</span><span class="p">.</span><span class="na">getTribuoProvenance</span><span class="p">().</span><span class="na">get</span><span class="p">()));</span><span class="w"></span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>ONNX file provenance:
FMClassificationModel(
	class-name = org.tribuo.classification.sgd.fm.FMClassificationModel
	dataset = MutableDataset(
			class-name = org.tribuo.MutableDataset
			datasource = IDXDataSource(
					class-name = org.tribuo.datasource.IDXDataSource
					outputFactory = LabelFactory(
							class-name = org.tribuo.classification.LabelFactory
						)
					outputPath = /local/ExternalRepositories/tribuo/tutorials/train-labels-idx1-ubyte.gz
					featuresPath = /local/ExternalRepositories/tribuo/tutorials/train-images-idx3-ubyte.gz
					features-file-modified-time = 2000-07-21T14:20:24-04:00
					output-resource-hash = 3552534A0A558BBED6AED32B30C495CCA23D567EC52CAC8BE1A0730E8010255C
					datasource-creation-time = 2022-10-07T11:45:53.253680-04:00
					output-file-modified-time = 2000-07-21T14:20:27-04:00
					idx-feature-type = UBYTE
					features-resource-hash = 440FCABF73CC546FA21475E81EA370265605F56BE210A4024D2CA8F203523609
					host-short-name = DataSource
				)
			transformations = List[]
			is-sequence = false
			is-dense = false
			num-examples = 60000
			num-features = 717
			num-outputs = 10
			tribuo-version = 4.3.0
		)
	trainer = FMClassificationTrainer(
			class-name = org.tribuo.classification.sgd.fm.FMClassificationTrainer
			seed = 12345
			variance = 0.1
			minibatchSize = 1
			factorizedDimSize = 6
			shuffle = true
			epochs = 5
			optimiser = AdaGrad(
					class-name = org.tribuo.math.optimisers.AdaGrad
					epsilon = 0.1
					initialLearningRate = 0.1
					initialValue = 0.0
					host-short-name = StochasticGradientOptimiser
				)
			loggingInterval = 30000
			objective = LogMulticlass(
					class-name = org.tribuo.classification.sgd.objectives.LogMulticlass
					host-short-name = LabelObjective
				)
			tribuo-version = 4.3.0
			train-invocation-count = 0
			is-sequence = false
			host-short-name = Trainer
		)
	trained-at = 2022-10-07T11:46:09.759423-04:00
	instance-values = Map{}
	tribuo-version = 4.3.0
	java-version = 12
	os-name = Linux
	os-arch = amd64
)
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We can also check that the provenance extracted from the ONNX file is the same as the provenance in the original model object.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[15]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-java"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="n">equality</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fmMNIST</span><span class="p">.</span><span class="na">getProvenance</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span><span class="n">onnxFM</span><span class="p">.</span><span class="na">getTribuoProvenance</span><span class="p">().</span><span class="na">get</span><span class="p">())</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s">&quot;equal&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s">&quot;not equal&quot;</span><span class="p">;</span><span class="w"></span>
<span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Provenances are &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">equality</span><span class="p">);</span><span class="w"></span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>Provenances are equal
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Exporting-an-ensemble">Exporting an ensemble<a class="anchor-link" href="#Exporting-an-ensemble">&#182;</a></h2><p>Tribuo allows the creation of arbitrary ensembles, and these are usually powerful models which are useful to deploy. So we're going to make a 3 element voting ensemble out of our factorization machine along with two other models and export that to ONNX as well. The other models are a logistic regression and a smaller factorization machine, but we could use any classification model supported by Tribuo, including another ensemble. As this is a small ensemble of similar models our goal is to demonstrate the functionality rather than improve performance on MNIST too much.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[16]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-java"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="n">lrTrainer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">LogisticRegressionTrainer</span><span class="p">();</span><span class="w"></span>
<span class="kd">var</span><span class="w"> </span><span class="n">smallFMTrainer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FMClassificationTrainer</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">LogMulticlass</span><span class="p">(),</span><span class="w">  </span><span class="c1">// Loss function</span><span class="w"></span>
<span class="w">                                                 </span><span class="k">new</span><span class="w"> </span><span class="n">AdaGrad</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">0.1</span><span class="p">),</span><span class="w"> </span><span class="c1">// Gradient optimiser</span><span class="w"></span>
<span class="w">                                                 </span><span class="mi">2</span><span class="p">,</span><span class="w">                    </span><span class="c1">// Number of training epochs</span><span class="w"></span>
<span class="w">                                                 </span><span class="mi">30000</span><span class="p">,</span><span class="w">                </span><span class="c1">// Logging interval</span><span class="w"></span>
<span class="w">                                                 </span><span class="mi">42L</span><span class="p">,</span><span class="w">                  </span><span class="c1">// RNG seed</span><span class="w"></span>
<span class="w">                                                 </span><span class="mi">3</span><span class="p">,</span><span class="w">                    </span><span class="c1">// Factor size</span><span class="w"></span>
<span class="w">                                                 </span><span class="mf">0.1</span><span class="w">                   </span><span class="c1">// Factor initialisation variance</span><span class="w"></span>
<span class="w">                                                 </span><span class="p">);</span><span class="w"></span>
<span class="kd">var</span><span class="w"> </span><span class="n">lrModel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lrTrainer</span><span class="p">.</span><span class="na">train</span><span class="p">(</span><span class="n">mnistTrain</span><span class="p">);</span><span class="w"></span>
<span class="kd">var</span><span class="w"> </span><span class="n">smallFMModel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">smallFMTrainer</span><span class="p">.</span><span class="na">train</span><span class="p">(</span><span class="n">mnistTrain</span><span class="p">);</span><span class="w"></span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Tribuo's <code>WeightedEnsembleModel</code> class allows the creation of arbitrary ensembles with or without voting weights. We're going to create an unweighted ensemble of our three models using the standard <code>VotingCombiner</code> which takes a majority vote between the three classes, with ties broken by the first label.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[17]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-java"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="n">ensemble</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WeightedEnsembleModel</span><span class="p">.</span><span class="na">createEnsembleFromExistingModels</span><span class="p">(</span><span class="s">&quot;ensemble&quot;</span><span class="p">,</span><span class="w"> </span><span class="c1">// Model name</span><span class="w"></span>
<span class="w">                                           </span><span class="n">List</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">fmMNIST</span><span class="p">,</span><span class="n">lrModel</span><span class="p">,</span><span class="n">smallFMModel</span><span class="p">),</span><span class="w"> </span><span class="c1">// Ensemble members</span><span class="w"></span>
<span class="w">                                           </span><span class="k">new</span><span class="w"> </span><span class="n">VotingCombiner</span><span class="p">());</span><span class="w">                 </span><span class="c1">// Combination operator</span><span class="w"></span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[18]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-java"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="n">ensembleStartTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">();</span><span class="w"></span>
<span class="kd">var</span><span class="w"> </span><span class="n">ensembleEval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">labelEvaluator</span><span class="p">.</span><span class="na">evaluate</span><span class="p">(</span><span class="n">ensemble</span><span class="p">,</span><span class="n">mnistTest</span><span class="p">);</span><span class="w"></span>
<span class="kd">var</span><span class="w"> </span><span class="n">ensembleEndTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">();</span><span class="w"></span>
<span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Scoring ensemble took &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Util</span><span class="p">.</span><span class="na">formatDuration</span><span class="p">(</span><span class="n">ensembleStartTime</span><span class="p">,</span><span class="n">ensembleEndTime</span><span class="p">));</span><span class="w"></span>
<span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">ensembleEval</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span><span class="w"></span>
<span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">ensembleEval</span><span class="p">.</span><span class="na">getConfusionMatrix</span><span class="p">().</span><span class="na">toString</span><span class="p">());</span><span class="w"></span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>Scoring ensemble took (00:00:00:611)
Class                           n          tp          fn          fp      recall        prec          f1
0                             980         965          15          43       0.985       0.957       0.971
1                           1,135       1,119          16          34       0.986       0.971       0.978
2                           1,032         979          53          86       0.949       0.919       0.934
3                           1,010         926          84          38       0.917       0.961       0.938
4                             982         937          45          49       0.954       0.950       0.952
5                             892         837          55          49       0.938       0.945       0.942
6                             958         922          36          32       0.962       0.966       0.964
7                           1,028         978          50          52       0.951       0.950       0.950
8                             974         918          56          98       0.943       0.904       0.923
9                           1,009         917          92          21       0.909       0.978       0.942
Total                      10,000       9,498         502         502
Accuracy                                                                    0.950
Micro Average                                                               0.950       0.950       0.950
Macro Average                                                               0.949       0.950       0.949
Balanced Error Rate                                                         0.051
               0       1       2       3       4       5       6       7       8       9
0            965       0       0       1       0       2       7       3       2       0
1              0   1,119       5       0       0       0       5       1       5       0
2              7       5     979       4       5       1       3       7      20       1
3              3       3      29     926       1      14       0       8      25       1
4              3       2      11       1     937       0       3       1      11      13
5              8       1       2       9       3     837      10       5      17       0
6              8       2       5       3       2      14     922       0       2       0
7              2       9      21       3       6       1       0     978       2       6
8              5       4      10       7      10       9       2       9     918       0
9              7       8       3      10      22       8       2      18      14     917

</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>As before, we use the <code>saveONNXModel</code> method on the <code>ONNXExportable</code> interface to write out the model. Note if one of the ensemble members isn't <code>ONNXExportable</code> then you'll get a runtime exception out of this call.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[19]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-java"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="n">ensemblePath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Paths</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">,</span><span class="s">&quot;ensemble-mnist.onnx&quot;</span><span class="p">);</span><span class="w"></span>
<span class="n">ensemble</span><span class="p">.</span><span class="na">saveONNXModel</span><span class="p">(</span><span class="s">&quot;org.tribuo.tutorials.onnxexport.ensemble&quot;</span><span class="p">,</span><span class="w"> </span><span class="c1">// namespace for the model</span><span class="w"></span>
<span class="w">                      </span><span class="mi">0</span><span class="p">,</span><span class="w">                                           </span><span class="c1">// model version number</span><span class="w"></span>
<span class="w">                      </span><span class="n">ensemblePath</span><span class="w">                                 </span><span class="c1">// path to save the model</span><span class="w"></span>
<span class="w">                      </span><span class="p">);</span><span class="w"></span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We can load this model into <code>ONNXExternalModel</code> as well:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[20]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-java"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="n">onnxEnsemble</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ONNXExternalModel</span><span class="p">.</span><span class="na">createOnnxModel</span><span class="p">(</span><span class="n">labelFactory</span><span class="p">,</span><span class="w"> </span><span class="n">mnistFeatureMap</span><span class="p">,</span><span class="w"> </span><span class="n">mnistOutputMap</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="n">denseTransformer</span><span class="p">,</span><span class="w"> </span><span class="n">labelTransformer</span><span class="p">,</span><span class="w"> </span><span class="n">sessionOpts</span><span class="p">,</span><span class="w"> </span><span class="n">ensemblePath</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;input&quot;</span><span class="p">);</span><span class="w"></span>
<span class="n">onnxStartTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">();</span><span class="w"></span>
<span class="kd">var</span><span class="w"> </span><span class="n">mnistONNXEnsembleEval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">labelEvaluator</span><span class="p">.</span><span class="na">evaluate</span><span class="p">(</span><span class="n">onnxEnsemble</span><span class="p">,</span><span class="n">mnistTest</span><span class="p">);</span><span class="w"></span>
<span class="n">onnxEndTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">();</span><span class="w"></span>
<span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Scoring ONNX ensemble took &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Util</span><span class="p">.</span><span class="na">formatDuration</span><span class="p">(</span><span class="n">onnxStartTime</span><span class="p">,</span><span class="n">onnxEndTime</span><span class="p">));</span><span class="w"></span>
<span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Predictions are equal - &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="w">                    </span><span class="n">checkPredictions</span><span class="p">(</span><span class="n">ensembleEval</span><span class="p">.</span><span class="na">getPredictions</span><span class="p">(),</span><span class="w"> </span><span class="n">mnistONNXEnsembleEval</span><span class="p">.</span><span class="na">getPredictions</span><span class="p">(),</span><span class="w"> </span><span class="mf">1e-5</span><span class="p">));</span><span class="w"></span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>Scoring ONNX ensemble took (00:00:00:938)
Predictions are equal - true
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Deploying-the-model">Deploying the model<a class="anchor-link" href="#Deploying-the-model">&#182;</a></h2><p>This portion of the tutorial describes how to deploy the ONNX model on OCI Data Science, using their model deployment service. ONNX models can also be deployed in many other machine learning cloud services, or via a functions-as-a-service offering using something like ONNX Runtime. ONNX models can also be deployed using <a href="https://blogs.oracle.com/machinelearning/post/introducing-oracle-machine-learning-services">Oracle Machine Learning Services</a>, or in many other environments, including other cloud providers.</p>
<p>Tribuo's OCI Data Science support comes in two parts, a set of static methods for deploying models in the cloud, and the <code>OCIModel</code> class which wraps a model endpoint and allows using it as a normal Tribuo model. Underneath the covers we're going to use an OCI DS conda environment which contains ONNX Runtime in Python, and use that to make predictions from our model trained in Java.</p>
<p>To run this part of the tutorial you'll need to have configured your access to OCI Data Science (if you've not done this before then you can see a tutorial on how to do that <a href="https://github.com/oracle/oci-data-science-ai-samples/blob/master/labs/MLSummit21/lab-0-tenancy-setup.md">here</a>), setup authentication to allow <a href="https://docs.oracle.com/en-us/iaas/Content/API/Concepts/sdkconfig.htm">CLI access to OCI</a> and you'll need the compartment &amp; project ids for the OCI Data Science project you want to deploy into.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[21]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-java"><pre><span></span><span class="c1">// Set these variables appropriately for your OCI account</span><span class="w"></span>
<span class="kd">var</span><span class="w"> </span><span class="n">compartmentID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;your-oci-compartment-id&quot;</span><span class="p">;</span><span class="w"></span>
<span class="kd">var</span><span class="w"> </span><span class="n">projectID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;your-oci-ds-project-id&quot;</span><span class="p">;</span><span class="w"></span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now we'll instantiate the DS client, and build the config object which captures all the information about the model we're uploading. The models are run inside a <a href="https://docs.oracle.com/en-us/iaas/data-science/using/conda_understand_environments.htm">conda environment</a>, and you need to select one which contains ONNX Runtime 1.6.0 or newer (as Tribuo emits ONNX models using Opset 13, which is supported in ONNX Runtime 1.6+). This can either be a custom one you've created, or one provided by OCI Data Science.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[22]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-java"><pre><span></span><span class="c1">// Instantiate the client</span><span class="w"></span>
<span class="kd">var</span><span class="w"> </span><span class="n">provider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ConfigFileAuthenticationDetailsProvider</span><span class="p">(</span><span class="n">ConfigFileReader</span><span class="p">.</span><span class="na">parseDefault</span><span class="p">());</span><span class="w"></span>
<span class="kd">var</span><span class="w"> </span><span class="n">dsClient</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DataScienceClient</span><span class="p">(</span><span class="n">provider</span><span class="p">);</span><span class="w"></span>

<span class="c1">// Instantiate an ObjectMapper for parsing the REST calls</span><span class="w"></span>
<span class="kd">var</span><span class="w"> </span><span class="n">objMapper</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OCIUtil</span><span class="p">.</span><span class="na">createObjectMapper</span><span class="p">();</span><span class="w"></span>

<span class="c1">// Select the conda environment</span><span class="w"></span>
<span class="kd">var</span><span class="w"> </span><span class="n">condaName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;dataexpl_p37_cpu_v3&quot;</span><span class="p">;</span><span class="w"> </span><span class="c1">// Also referred to as the &quot;slug&quot; in the OCI DS docs</span><span class="w"></span>
<span class="kd">var</span><span class="w"> </span><span class="n">condaPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;oci://service-conda-packs@id19sfcrra6z/service_pack/cpu/Data Exploration and Manipulation for CPU Python 3.7/3.0/dataexpl_p37_cpu_v3&quot;</span><span class="p">;</span><span class="w"></span>

<span class="c1">// Instantiate the model configuration</span><span class="w"></span>
<span class="kd">var</span><span class="w"> </span><span class="n">dsConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">OCIUtil</span><span class="p">.</span><span class="na">OCIDSConfig</span><span class="p">(</span><span class="n">compartmentID</span><span class="p">,</span><span class="n">projectID</span><span class="p">);</span><span class="w"></span>
<span class="kd">var</span><span class="w"> </span><span class="n">modelConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">OCIUtil</span><span class="p">.</span><span class="na">OCIModelArtifactConfig</span><span class="p">(</span><span class="n">dsConfig</span><span class="p">,</span><span class="w">          </span><span class="c1">// Data Science config</span><span class="w"></span>
<span class="w">                                             </span><span class="s">&quot;tribuo-tutorial-model&quot;</span><span class="p">,</span><span class="w">   </span><span class="c1">// Model name</span><span class="w"></span>
<span class="w">                                             </span><span class="s">&quot;A factorization machine&quot;</span><span class="p">,</span><span class="w"> </span><span class="c1">// Model description</span><span class="w"></span>
<span class="w">                                             </span><span class="s">&quot;org.tribuo.tutorial.test&quot;</span><span class="p">,</span><span class="c1">// ONNX model domain</span><span class="w"></span>
<span class="w">                                             </span><span class="mi">0</span><span class="p">,</span><span class="w">                         </span><span class="c1">// ONNX model version</span><span class="w"></span>
<span class="w">                                             </span><span class="n">condaName</span><span class="p">,</span><span class="w">                 </span><span class="c1">// Conda environment name</span><span class="w"></span>
<span class="w">                                             </span><span class="n">condaPath</span><span class="p">);</span><span class="w">                </span><span class="c1">// Conda environment path on object storage</span><span class="w"></span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We can now upload the model into OCI Data Science. The <code>createModel</code> method has an overload that accepts an ONNX file on disk, or you can pass in any model which implements <code>ONNXExportable</code>. Tribuo takes care of setting the model metadata according to the information it can extract from the <code>Model</code> object, and it automatically generates the necessary python script and yaml file which control the model's environment in the deployment. Note models are distinct from model deployments, so a single model artifact can be deployed multiple times with different endpoints, VM sizes and scaling parameters.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[23]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-java"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="n">modelID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OCIUtil</span><span class="p">.</span><span class="na">createModel</span><span class="p">(</span><span class="n">fmMNIST</span><span class="p">,</span><span class="n">dsClient</span><span class="p">,</span><span class="n">objMapper</span><span class="p">,</span><span class="n">modelConfig</span><span class="p">);</span><span class="w"></span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The <code>modelID</code> is the reference for the model artifact stored in Oracle Cloud, and we'll need this to create a deployment wrapping the model.</p>
<p>To specify the model deployment configuration there's a <code>OCIModelDeploymentConfig</code> wrapper class, it contains the model ID, the model deployment name, the VM shape, maximum number of VM instances to create, and the bandwidth available for that model. At time of writing OCI DS supports the <code>VM.Standard2</code> shapes.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[24]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-java"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="n">deployConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">OCIUtil</span><span class="p">.</span><span class="na">OCIModelDeploymentConfig</span><span class="p">(</span><span class="n">dsConfig</span><span class="p">,</span><span class="n">modelID</span><span class="p">,</span><span class="s">&quot;tribuo-tutorial-deployment&quot;</span><span class="p">,</span><span class="s">&quot;VM.Standard2.1&quot;</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>

<span class="kd">var</span><span class="w"> </span><span class="n">deployURL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OCIUtil</span><span class="p">.</span><span class="na">deploy</span><span class="p">(</span><span class="n">deployConfig</span><span class="p">,</span><span class="n">dsClient</span><span class="p">,</span><span class="n">objMapper</span><span class="p">);</span><span class="w"></span>
<span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">deployURL</span><span class="p">);</span><span class="w"></span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Model deployments take a few minutes, so you'll need to wait a while if you've been following along with the tutorial. The deployment progress can be checked on the OCI console for the data science project you are using.</p>
<p>Once the deployment has finished, we can wrap it in an <code>OCIModel</code> and then check it's the same as the factorization machine we deployed. An <code>OCIModel</code> is a subclass of <code>ExternalModel</code> in the same way that externally trained ONNX models are, so we need to supply the mapping between Tribuo's feature domain &amp; the feature indices expected by the model, the output domain mapping, and a <code>OCIOutputConverter</code> instance which can convert the prediction matrix into Tribuo's <code>Prediction</code> objects. As we've deployed a factorization machine for MNIST, we'll use <code>OCILabelConverter</code>, and the mappings are the same as the ones we used for the ONNX model earlier.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[25]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-java"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="n">ociLabelConverter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">OCILabelConverter</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w"></span>
<span class="kd">var</span><span class="w"> </span><span class="n">ociModel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OCIModel</span><span class="p">.</span><span class="na">createOCIModel</span><span class="p">(</span><span class="n">labelFactory</span><span class="p">,</span><span class="n">mnistFeatureMap</span><span class="p">,</span><span class="w"> </span><span class="n">mnistOutputMap</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                       </span><span class="n">Paths</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;~/.oci/config&quot;</span><span class="p">),</span><span class="w"> </span><span class="c1">// OCI authentication config</span><span class="w"></span>
<span class="w">                                       </span><span class="n">deployURL</span><span class="p">,</span><span class="w">                  </span><span class="c1">// Model endpoint URL</span><span class="w"></span>
<span class="w">                                       </span><span class="n">ociLabelConverter</span><span class="p">);</span><span class="w">         </span><span class="c1">// Output converter</span><span class="w"></span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>As <code>OCIModel</code> is a Tribuo model we can evaluate it using our standard tools.</p>
<p>Note when running this notebook from scratch the OCI Model Deployment can take up to 15 minutes to fully instantiate, and the next cell will not execute correctly until that deployment has finished. You can monitor the status of the deployment in the OCI console.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[26]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-java"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="n">ociStartTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">();</span><span class="w"></span>
<span class="kd">var</span><span class="w"> </span><span class="n">ociEval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">labelEvaluator</span><span class="p">.</span><span class="na">evaluate</span><span class="p">(</span><span class="n">ociModel</span><span class="p">,</span><span class="n">mnistTest</span><span class="p">);</span><span class="w"></span>
<span class="kd">var</span><span class="w"> </span><span class="n">ociEndTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">();</span><span class="w"></span>
<span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Scoring OCI model took &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Util</span><span class="p">.</span><span class="na">formatDuration</span><span class="p">(</span><span class="n">ociStartTime</span><span class="p">,</span><span class="n">ociEndTime</span><span class="p">));</span><span class="w"></span>
<span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">ociEval</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span><span class="w"></span>
<span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">ociEval</span><span class="p">.</span><span class="na">getConfusionMatrix</span><span class="p">().</span><span class="na">toString</span><span class="p">());</span><span class="w"></span>

<span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Predictions are equal - &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="w">                    </span><span class="n">checkPredictions</span><span class="p">(</span><span class="n">ociEval</span><span class="p">.</span><span class="na">getPredictions</span><span class="p">(),</span><span class="w"> </span><span class="n">mnistFMEval</span><span class="p">.</span><span class="na">getPredictions</span><span class="p">(),</span><span class="w"> </span><span class="mf">1e-5</span><span class="p">));</span><span class="w"></span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>Scoring OCI model took (00:00:53:606)
Class                           n          tp          fn          fp      recall        prec          f1
0                             980         959          21          31       0.979       0.969       0.974
1                           1,135       1,120          15          22       0.987       0.981       0.984
2                           1,032         976          56          57       0.946       0.945       0.945
3                           1,010         952          58          39       0.943       0.961       0.952
4                             982         952          30          49       0.969       0.951       0.960
5                             892         857          35          63       0.961       0.932       0.946
6                             958         920          38          30       0.960       0.968       0.964
7                           1,028         969          59          36       0.943       0.964       0.953
8                             974         916          58          57       0.940       0.941       0.941
9                           1,009         951          58          44       0.943       0.956       0.949
Total                      10,000       9,572         428         428
Accuracy                                                                    0.957
Micro Average                                                               0.957       0.957       0.957
Macro Average                                                               0.957       0.957       0.957
Balanced Error Rate                                                         0.043
               0       1       2       3       4       5       6       7       8       9
0            959       0       0       0       1       2       7       4       4       3
1              0   1,120       4       1       3       0       3       0       4       0
2              6       5     976       7       7       2       5       8      14       2
3              0       2      15     952       0      19       1       3      14       4
4              3       3       7       1     952       0       4       1       1      10
5              3       1       0       6       1     857       5       5      13       1
6              8       2       7       2       7      11     920       1       0       0
7              2       5      13       5       4       4       0     969       4      22
8              2       1       9       9      11      15       4       5     916       2
9              7       3       2       8      15      10       1       9       3     951

Predictions are equal - true
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We can see that the model performs identically to the Tribuo version, though it takes a little longer as each call to predict incurs some network latency.</p>
<h2 id="Conclusion">Conclusion<a class="anchor-link" href="#Conclusion">&#182;</a></h2><p>We've looked at exporting models out of Tribuo in ONNX format, where they can be used in different languages, runtimes and deployed in cloud environments like OCI Data Science. Over time we plan to expand Tribuo's support for ONNX export to cover more models. Tribuo's ONNX support is a separate module from the rest of Tribuo and could be used to build ONNX models in other packages on the JVM. If you're interested in expanding the support for ONNX in Java, you can open a <a href="https://github.com/oracle/tribuo/issues">Github issue</a> for Tribuo, or you can talk to the ONNX community in their <a href="https://onnx.ai/slack.html">Slack workspace</a>.</p>

</div>
</div>
</div>
    </div>
  </div>
</body>

