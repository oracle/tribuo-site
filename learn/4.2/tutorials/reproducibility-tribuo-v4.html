---
title: "Reproducibility"
og-title: "Reproducibility Tutorial"
learn_nav: true
parent: Tutorials
nav_order: 313
is_notebook: true
notebook_url: https://github.com/oracle/tribuo/blob/main/tutorials/reproducibility-tribuo-v4.ipynb
comment: ## DO NOT EDIT THIS FILE. IT IS COPIED FROM THE TRIBUO DOC. EDIT IT THERE. ##
---
    <div class="container" id="notebook-container">

<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Reproducibility-Tutorial">Reproducibility Tutorial<a class="anchor-link" href="#Reproducibility-Tutorial">&#182;</a></h1><p>Reproducibility of ML models and evaluations is frequently a problem across many ML systems. It's usually two problems, the first is a description of the computation that was executed, and the second is a method of replaying that computation. In Tribuo we built our provenance system to make our models <em>self-describing</em> by which we mean they capture a complete description of the computation that produced them, solving the first issue. In v4.2 we added an automated reproducibility system which consumes the provenance data and retrains the model. As well as the reproducibility system we also added a mechanism for diffing provenance objects allowing easy comparison between the reproduced and original models. This is because the models are only guaranteed to be identical if the data is the same, and any differences in the data will show up in the data provenance object.</p>
<h2 id="Setup">Setup<a class="anchor-link" href="#Setup">&#182;</a></h2><p>Before running this tutorial, please run the irises classification and ONNX export tutorial to build the two models that we're going to reproduce.</p>
<p>We're going to load in the classification jar, onnx jar, and the reproducibility jar. Note the reproducibility jar is written in Java 16, and so this tutorial requires Java 16 or later. Then we'll import the necessary classes.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[1]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-java"><pre><span></span><span class="o">%</span><span class="n">jars</span> <span class="p">.</span><span class="o">/</span><span class="n">tribuo</span><span class="o">-</span><span class="n">classification</span><span class="o">-</span><span class="n">experiments</span><span class="o">-</span><span class="mf">4.2.0</span><span class="o">-</span><span class="n">jar</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">dependencies</span><span class="p">.</span><span class="na">jar</span>
<span class="o">%</span><span class="n">jars</span> <span class="p">.</span><span class="o">/</span><span class="n">tribuo</span><span class="o">-</span><span class="n">onnx</span><span class="o">-</span><span class="mf">4.2.0</span><span class="o">-</span><span class="n">jar</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">dependencies</span><span class="p">.</span><span class="na">jar</span>
<span class="o">%</span><span class="n">jars</span> <span class="p">.</span><span class="o">/</span><span class="n">tribuo</span><span class="o">-</span><span class="n">json</span><span class="o">-</span><span class="mf">4.2.0</span><span class="o">-</span><span class="n">jar</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">dependencies</span><span class="p">.</span><span class="na">jar</span>
<span class="o">%</span><span class="n">jars</span> <span class="p">.</span><span class="o">/</span><span class="n">tribuo</span><span class="o">-</span><span class="n">reproducibility</span><span class="o">-</span><span class="mf">4.2.0</span><span class="o">-</span><span class="n">jar</span><span class="o">-</span><span class="n">with</span><span class="o">-</span><span class="n">dependencies</span><span class="p">.</span><span class="na">jar</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[2]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-java"><pre><span></span><span class="kn">import</span> <span class="nn">org.tribuo.*</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.tribuo.classification.*</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.tribuo.classification.evaluation.*</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.tribuo.classification.sgd.fm.*</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.tribuo.classification.sgd.linear.*</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.tribuo.datasource.*</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.tribuo.interop.onnx.*</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.tribuo.reproducibility.*</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.oracle.labs.mlrg.olcut.provenance.*</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com.oracle.labs.mlrg.olcut.util.*</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">ai.onnxruntime.*</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.nio.file.*</span><span class="p">;</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Reproducing-a-Tribuo-Model">Reproducing a Tribuo Model<a class="anchor-link" href="#Reproducing-a-Tribuo-Model">&#182;</a></h2><p>The reproducibility system works on Tribuo <code>Model</code> or <code>ModelProvenance</code> objects. When using the <code>ModelProvenance</code> the system loads in the original training data, processes and transforms it according to the columnar processing and transforms applied, then rebuilds the original trainer including it's RNG state, before passing the data into the train method and returning the reproduced model. When using the <code>Model</code> object, it performs the same steps as for a <code>ModelProvenance</code> and then compares the feature and output domains to provide more information about any differences between the feature and output domains used by the model. Over time we plan to expand the validation applied to the reproduced model to show if the features have different ranges or histograms.</p>
<p>We're going to load in the Irises logistic regression model trained in the first tutorial.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[3]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-java"><pre><span></span><span class="n">File</span> <span class="n">irisModelFile</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="p">(</span><span class="s">&quot;iris-lr-model.ser&quot;</span><span class="p">);</span>
<span class="n">String</span> <span class="n">filterPattern</span> <span class="o">=</span> <span class="n">Files</span><span class="p">.</span><span class="na">readAllLines</span><span class="p">(</span><span class="n">Paths</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;../docs/jep-290-filter.txt&quot;</span><span class="p">)).</span><span class="na">get</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="n">ObjectInputFilter</span> <span class="n">filter</span> <span class="o">=</span> <span class="n">ObjectInputFilter</span><span class="p">.</span><span class="na">Config</span><span class="p">.</span><span class="na">createFilter</span><span class="p">(</span><span class="n">filterPattern</span><span class="p">);</span>
<span class="n">LinearSGDModel</span> <span class="n">loadedModel</span><span class="p">;</span>
<span class="k">try</span> <span class="p">(</span><span class="n">ObjectInputStream</span> <span class="n">ois</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectInputStream</span><span class="p">(</span><span class="k">new</span> <span class="n">BufferedInputStream</span><span class="p">(</span><span class="k">new</span> <span class="n">FileInputStream</span><span class="p">(</span><span class="n">irisModelFile</span><span class="p">))))</span> <span class="p">{</span>
    <span class="n">ois</span><span class="p">.</span><span class="na">setObjectInputFilter</span><span class="p">(</span><span class="n">filter</span><span class="p">);</span>
    <span class="n">loadedModel</span> <span class="o">=</span> <span class="p">(</span><span class="n">LinearSGDModel</span><span class="p">)</span> <span class="n">ois</span><span class="p">.</span><span class="na">readObject</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">loadedModel</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>linear-sgd-model - Model(class-name=org.tribuo.classification.sgd.linear.LinearSGDModel,dataset=Dataset(class-name=org.tribuo.MutableDataset,datasource=SplitDataSourceProvenance(className=org.tribuo.evaluation.TrainTestSplitter,innerSourceProvenance=DataSource(class-name=org.tribuo.data.csv.CSVDataSource,headers=[sepalLength, sepalWidth, petalLength, petalWidth, species],rowProcessor=RowProcessor(class-name=org.tribuo.data.columnar.RowProcessor,metadataExtractors=[],fieldProcessorList=[FieldProcessor(class-name=org.tribuo.data.columnar.processors.field.DoubleFieldProcessor,fieldName=petalLength,onlyFieldName=true,throwOnInvalid=true,host-short-name=FieldProcessor), FieldProcessor(class-name=org.tribuo.data.columnar.processors.field.DoubleFieldProcessor,fieldName=petalWidth,onlyFieldName=true,throwOnInvalid=true,host-short-name=FieldProcessor), FieldProcessor(class-name=org.tribuo.data.columnar.processors.field.DoubleFieldProcessor,fieldName=sepalWidth,onlyFieldName=true,throwOnInvalid=true,host-short-name=FieldProcessor), FieldProcessor(class-name=org.tribuo.data.columnar.processors.field.DoubleFieldProcessor,fieldName=sepalLength,onlyFieldName=true,throwOnInvalid=true,host-short-name=FieldProcessor)],featureProcessors=[],responseProcessor=ResponseProcessor(class-name=org.tribuo.data.columnar.processors.response.FieldResponseProcessor,uppercase=false,fieldNames=[species],defaultValues=[],displayField=false,outputFactory=OutputFactory(class-name=org.tribuo.classification.LabelFactory),host-short-name=ResponseProcessor),weightExtractor=null,replaceNewlinesWithSpaces=true,regexMappingProcessors={},host-short-name=RowProcessor),quote=&#34;,outputRequired=true,outputFactory=OutputFactory(class-name=org.tribuo.classification.LabelFactory),separator=,,dataPath=/Users/apocock/Development/Tribuo/tutorials/bezdekIris.data,resource-hash=SHA-256[0FED2A99DB77EC533A62DC66894D3EC6DF3B58B6A8F3CF4A6B47E4086B7F97DC],file-modified-time=1999-12-14T15:12:39-05:00,datasource-creation-time=2021-12-18T20:31:02.286464-05:00,host-short-name=DataSource),trainProportion=0.7,seed=1,size=150,isTrain=true),transformations=[],is-sequence=false,is-dense=true,num-examples=105,num-features=4,num-outputs=3,tribuo-version=4.2.0),trainer=Trainer(class-name=org.tribuo.classification.sgd.linear.LogisticRegressionTrainer,seed=12345,minibatchSize=1,shuffle=true,epochs=5,optimiser=StochasticGradientOptimiser(class-name=org.tribuo.math.optimisers.AdaGrad,epsilon=0.1,initialLearningRate=1.0,initialValue=0.0,host-short-name=StochasticGradientOptimiser),loggingInterval=1000,objective=LabelObjective(class-name=org.tribuo.classification.sgd.objectives.LogMulticlass,host-short-name=LabelObjective),tribuo-version=4.2.0,train-invocation-count=0,is-sequence=false,host-short-name=Trainer),trained-at=2021-12-18T20:31:02.707624-05:00,instance-values={},tribuo-version=4.2.0,java-version=17.0.1,os-name=Mac OS X,os-arch=x86_64)
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The reproducibility system lives in the <code>ReproUtil</code> class. This class is constructed with a <code>Model</code> or a <code>ModelProvenance</code> and <code>Class&lt;T extends Output&lt;T&gt;&gt;</code> for the output class.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[4]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-java"><pre><span></span><span class="kd">var</span> <span class="n">repro</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ReproUtil</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">loadedModel</span><span class="p">);</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now we can separately rebuild the dataset and the trainer, though note if you mutate the objects returned by these methods then you won't get the exact same model back from the reproduction. We're still working on the API for the reproducibility system and expect to make this API more robust over time.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[5]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-java"><pre><span></span><span class="kd">var</span> <span class="n">dataset</span> <span class="o">=</span> <span class="n">repro</span><span class="p">.</span><span class="na">recoverDataset</span><span class="p">();</span>

<span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">ProvenanceUtil</span><span class="p">.</span><span class="na">formattedProvenanceString</span><span class="p">(</span><span class="n">dataset</span><span class="p">.</span><span class="na">getProvenance</span><span class="p">()));</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>MutableDataset(
	class-name = org.tribuo.MutableDataset
	datasource = TrainTestSplitter(
			class-name = org.tribuo.evaluation.TrainTestSplitter
			source = CSVDataSource(
					class-name = org.tribuo.data.csv.CSVDataSource
					headers = List[
						sepalLength
						sepalWidth
						petalLength
						petalWidth
						species
					]
					rowProcessor = RowProcessor(
							class-name = org.tribuo.data.columnar.RowProcessor
							metadataExtractors = List[]
							fieldProcessorList = List[
								DoubleFieldProcessor(
											class-name = org.tribuo.data.columnar.processors.field.DoubleFieldProcessor
											fieldName = petalLength
											onlyFieldName = true
											throwOnInvalid = true
											host-short-name = FieldProcessor
										)
								DoubleFieldProcessor(
											class-name = org.tribuo.data.columnar.processors.field.DoubleFieldProcessor
											fieldName = petalWidth
											onlyFieldName = true
											throwOnInvalid = true
											host-short-name = FieldProcessor
										)
								DoubleFieldProcessor(
											class-name = org.tribuo.data.columnar.processors.field.DoubleFieldProcessor
											fieldName = sepalWidth
											onlyFieldName = true
											throwOnInvalid = true
											host-short-name = FieldProcessor
										)
								DoubleFieldProcessor(
											class-name = org.tribuo.data.columnar.processors.field.DoubleFieldProcessor
											fieldName = sepalLength
											onlyFieldName = true
											throwOnInvalid = true
											host-short-name = FieldProcessor
										)
							]
							featureProcessors = List[]
							responseProcessor = FieldResponseProcessor(
									class-name = org.tribuo.data.columnar.processors.response.FieldResponseProcessor
									uppercase = false
									fieldNames = List[
										species
									]
									defaultValues = List[
										
									]
									displayField = false
									outputFactory = LabelFactory(
											class-name = org.tribuo.classification.LabelFactory
										)
									host-short-name = ResponseProcessor
								)
							weightExtractor = FieldExtractor(
									class-name = org.tribuo.data.columnar.FieldExtractor
								)
							replaceNewlinesWithSpaces = true
							regexMappingProcessors = Map{}
							host-short-name = RowProcessor
						)
					quote = &#34;
					outputRequired = true
					outputFactory = LabelFactory(
							class-name = org.tribuo.classification.LabelFactory
						)
					separator = ,
					dataPath = /Users/apocock/Development/Tribuo/tutorials/bezdekIris.data
					resource-hash = 0FED2A99DB77EC533A62DC66894D3EC6DF3B58B6A8F3CF4A6B47E4086B7F97DC
					file-modified-time = 1999-12-14T15:12:39-05:00
					datasource-creation-time = 2021-12-18T20:38:43.398834-05:00
					host-short-name = DataSource
				)
			train-proportion = 0.7
			seed = 1
			size = 150
			is-train = true
		)
	transformations = List[]
	is-sequence = false
	is-dense = true
	num-examples = 105
	num-features = 4
	num-outputs = 3
	tribuo-version = 4.2.0
)
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Our irises dataset was loaded in using the <code>CSVLoader</code> and split with a 70/30 train test split, and we can see that the reproduced training dataset has been split just as we expect.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[6]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-java"><pre><span></span><span class="kd">var</span> <span class="n">trainer</span> <span class="o">=</span> <span class="n">repro</span><span class="p">.</span><span class="na">recoverTrainer</span><span class="p">();</span>
<span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">ProvenanceUtil</span><span class="p">.</span><span class="na">formattedProvenanceString</span><span class="p">(</span><span class="n">trainer</span><span class="p">.</span><span class="na">getProvenance</span><span class="p">()));</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>LogisticRegressionTrainer(
	class-name = org.tribuo.classification.sgd.linear.LogisticRegressionTrainer
	seed = 12345
	minibatchSize = 1
	shuffle = true
	epochs = 5
	optimiser = AdaGrad(
			class-name = org.tribuo.math.optimisers.AdaGrad
			epsilon = 0.1
			initialLearningRate = 1.0
			initialValue = 0.0
			host-short-name = StochasticGradientOptimiser
		)
	loggingInterval = 1000
	objective = LogMulticlass(
			class-name = org.tribuo.classification.sgd.objectives.LogMulticlass
			host-short-name = LabelObjective
		)
	tribuo-version = 4.2.0
	train-invocation-count = 0
	is-sequence = false
	host-short-name = Trainer
)
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The irises model is a logistic regression, using seed <code>12345</code> and it's the first model trained by that trainer (as <code>train-invocation-count</code> is zero).</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[7]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-java"><pre><span></span><span class="kd">var</span> <span class="n">reproduction</span> <span class="o">=</span> <span class="n">repro</span><span class="p">.</span><span class="na">reproduceFromModel</span><span class="p">();</span>
<span class="kd">var</span> <span class="n">reproducedModel</span> <span class="o">=</span> <span class="p">(</span><span class="n">LinearSGDModel</span><span class="p">)</span> <span class="n">reproduction</span><span class="p">.</span><span class="na">model</span><span class="p">();</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We can compare this provenance to the one in the original model using our diff tool, however as Tribuo records construction timestamps they will not be identical.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[8]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-java"><pre><span></span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">ReproUtil</span><span class="p">.</span><span class="na">diffProvenance</span><span class="p">(</span><span class="n">loadedModel</span><span class="p">.</span><span class="na">getProvenance</span><span class="p">(),</span><span class="n">reproducedModel</span><span class="p">.</span><span class="na">getProvenance</span><span class="p">()));</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>{
  &#34;dataset&#34; : {
    &#34;datasource&#34; : {
      &#34;source&#34; : {
        &#34;datasource-creation-time&#34; : {
          &#34;original&#34; : &#34;2021-12-18T20:31:02.286464-05:00&#34;,
          &#34;reproduced&#34; : &#34;2021-12-18T20:38:43.398834-05:00&#34;
        }
      }
    }
  },
  &#34;trained-at&#34; : {
    &#34;original&#34; : &#34;2021-12-18T20:31:02.707624-05:00&#34;,
    &#34;reproduced&#34; : &#34;2021-12-18T20:38:43.655448-05:00&#34;
  }
}
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We can see that the timestamps are a little different, though the precise difference will depend on when you ran the irises tutorial. You may also see differences in the JVM or other machine provenance if you ran that tutorial on a different machine. If the irises dataset grows a new feature or additional rows in the same file, then the diff will show that the datasets have different numbers of features or samples, and that the file has a different hash.</p>
<p>For some models we can easily compare the model contents, e.g., for the logistic regression we can directly compare the model weights.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[9]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-java"><pre><span></span><span class="kd">var</span> <span class="n">originalWeights</span> <span class="o">=</span> <span class="n">loadedModel</span><span class="p">.</span><span class="na">getWeightsCopy</span><span class="p">();</span>
<span class="kd">var</span> <span class="n">reproducedWeights</span> <span class="o">=</span> <span class="n">reproducedModel</span><span class="p">.</span><span class="na">getWeightsCopy</span><span class="p">();</span>

<span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Weights are equal = &quot;</span> <span class="o">+</span> <span class="n">originalWeights</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">reproducedWeights</span><span class="p">));</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>Weights are equal = true
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Reproducing-an-ONNX-exported-Tribuo-Model">Reproducing an ONNX exported Tribuo Model<a class="anchor-link" href="#Reproducing-an-ONNX-exported-Tribuo-Model">&#182;</a></h2><p>Tribuo models can be exported into the <a href="https://onnx.ai">ONNX</a> format. When Tribuo models are exported the model provenance is stored as a metadata field in the ONNX file. This doesn't affect anything which serves the ONNX model, but allows Tribuo to load the provenance back in if the model is loaded in as an <code>ONNXExternalModel</code> which is Tribuo's class for loading in ONNX models.</p>
<p>To load a model in as an <code>ONNXExternalModel</code> we need to define the feature and label mappings which should be written out separately when the ONNX model is exported. We're going to cheat slightly and get them from the MNIST training set itself.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[10]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-java"><pre><span></span><span class="kd">var</span> <span class="n">labelFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LabelFactory</span><span class="p">();</span>
<span class="kd">var</span> <span class="n">mnistTrainSource</span> <span class="o">=</span> <span class="k">new</span> <span class="n">IDXDataSource</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">Paths</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;train-images-idx3-ubyte.gz&quot;</span><span class="p">),</span><span class="n">Paths</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;train-labels-idx1-ubyte.gz&quot;</span><span class="p">),</span><span class="n">labelFactory</span><span class="p">);</span>
<span class="kd">var</span> <span class="n">mnistTestSource</span> <span class="o">=</span> <span class="k">new</span> <span class="n">IDXDataSource</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">Paths</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;t10k-images-idx3-ubyte.gz&quot;</span><span class="p">),</span><span class="n">Paths</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;t10k-labels-idx1-ubyte.gz&quot;</span><span class="p">),</span><span class="n">labelFactory</span><span class="p">);</span>
<span class="kd">var</span> <span class="n">mnistTrain</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MutableDataset</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">mnistTrainSource</span><span class="p">);</span>
<span class="kd">var</span> <span class="n">mnistTest</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MutableDataset</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">mnistTestSource</span><span class="p">);</span>

<span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">mnistFeatureMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<span class="k">for</span> <span class="p">(</span><span class="n">VariableInfo</span> <span class="n">f</span> <span class="p">:</span> <span class="n">mnistTrain</span><span class="p">.</span><span class="na">getFeatureIDMap</span><span class="p">()){</span>
    <span class="n">VariableIDInfo</span> <span class="n">id</span> <span class="o">=</span> <span class="p">(</span><span class="n">VariableIDInfo</span><span class="p">)</span> <span class="n">f</span><span class="p">;</span>
    <span class="n">mnistFeatureMap</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">id</span><span class="p">.</span><span class="na">getName</span><span class="p">(),</span><span class="n">id</span><span class="p">.</span><span class="na">getID</span><span class="p">());</span>
<span class="p">}</span>
<span class="n">Map</span><span class="o">&lt;</span><span class="n">Label</span><span class="p">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">mnistOutputMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<span class="k">for</span> <span class="p">(</span><span class="n">Pair</span><span class="o">&lt;</span><span class="n">Integer</span><span class="p">,</span><span class="n">Label</span><span class="o">&gt;</span> <span class="n">l</span> <span class="p">:</span> <span class="n">mnistTrain</span><span class="p">.</span><span class="na">getOutputIDInfo</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">mnistOutputMap</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">l</span><span class="p">.</span><span class="na">getB</span><span class="p">(),</span> <span class="n">l</span><span class="p">.</span><span class="na">getA</span><span class="p">());</span>
<span class="p">}</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now let's load in the ONNX file:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[11]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-java"><pre><span></span><span class="kd">var</span> <span class="n">ortEnv</span> <span class="o">=</span> <span class="n">OrtEnvironment</span><span class="p">.</span><span class="na">getEnvironment</span><span class="p">();</span>
<span class="kd">var</span> <span class="n">sessionOpts</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OrtSession</span><span class="p">.</span><span class="na">SessionOptions</span><span class="p">();</span>
<span class="kd">var</span> <span class="n">denseTransformer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DenseTransformer</span><span class="p">();</span>
<span class="kd">var</span> <span class="n">labelTransformer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LabelTransformer</span><span class="p">();</span>
<span class="kd">var</span> <span class="n">mnistModelPath</span> <span class="o">=</span> <span class="n">Paths</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">,</span><span class="s">&quot;fm-mnist.onnx&quot;</span><span class="p">);</span>
<span class="n">ONNXExternalModel</span><span class="o">&lt;</span><span class="n">Label</span><span class="o">&gt;</span> <span class="n">onnx</span> <span class="o">=</span> <span class="n">ONNXExternalModel</span><span class="p">.</span><span class="na">createOnnxModel</span><span class="p">(</span><span class="n">labelFactory</span><span class="p">,</span> <span class="n">mnistFeatureMap</span><span class="p">,</span> <span class="n">mnistOutputMap</span><span class="p">,</span>
                    <span class="n">denseTransformer</span><span class="p">,</span> <span class="n">labelTransformer</span><span class="p">,</span> <span class="n">sessionOpts</span><span class="p">,</span> <span class="n">mnistModelPath</span><span class="p">,</span> <span class="s">&quot;input&quot;</span><span class="p">);</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This model has two provenance objects, one from the creation of the <code>ONNXExternalModel</code>, and one from the original training run in Tribuo which is persisted inside the ONNX file.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[12]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-java"><pre><span></span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">ProvenanceUtil</span><span class="p">.</span><span class="na">formattedProvenanceString</span><span class="p">(</span><span class="n">onnx</span><span class="p">.</span><span class="na">getProvenance</span><span class="p">()));</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>ONNXExternalModel(
	class-name = org.tribuo.interop.onnx.ONNXExternalModel
	dataset = Dataset(
			class-name = org.tribuo.Dataset
			datasource = DataSource(
					description = unknown-external-data
					outputFactory = LabelFactory(
							class-name = org.tribuo.classification.LabelFactory
						)
					datasource-creation-time = 2021-12-18T20:38:52.702297-05:00
				)
			transformations = List[]
			is-sequence = false
			is-dense = false
			num-examples = -1
			num-features = 717
			num-outputs = 10
			tribuo-version = 4.2.0
		)
	trainer = Trainer(
			class-name = org.tribuo.Trainer
			fileModifiedTime = 2021-12-18T20:36:36.445-05:00
			modelHash = 06071247AEDE7539B899A2D530508D8E2B43304B8A7884A257368AA2CF1C18ED
			location = file:/Users/apocock/Development/Tribuo/tutorials/./fm-mnist.onnx
		)
	trained-at = 2021-12-18T20:38:52.700329-05:00
	instance-values = Map{
		model-domain=org.tribuo.tutorials.onnxexport.fm
		model-graphname=FMClassificationModel
		model-description=factorization-machine-model - Model(class-name=org.tribuo.classification.sgd.fm.FMClassificationModel,dataset=Dataset(class-name=org.tribuo.MutableDataset,datasource=DataSource(class-name=org.tribuo.datasource.IDXDataSource,outputPath=/Users/apocock/Development/Tribuo/tutorials/train-labels-idx1-ubyte.gz,outputFactory=OutputFactory(class-name=org.tribuo.classification.LabelFactory),featuresPath=/Users/apocock/Development/Tribuo/tutorials/train-images-idx3-ubyte.gz,features-file-modified-time=2000-07-21T14:20:24-04:00,output-resource-hash=SHA-256[3552534A0A558BBED6AED32B30C495CCA23D567EC52CAC8BE1A0730E8010255C],datasource-creation-time=2021-12-18T20:36:23.109293-05:00,output-file-modified-time=2000-07-21T14:20:27-04:00,idx-feature-type=UBYTE,features-resource-hash=SHA-256[440FCABF73CC546FA21475E81EA370265605F56BE210A4024D2CA8F203523609],host-short-name=DataSource),transformations=[],is-sequence=false,is-dense=false,num-examples=60000,num-features=717,num-outputs=10,tribuo-version=4.2.0),trainer=Trainer(class-name=org.tribuo.classification.sgd.fm.FMClassificationTrainer,seed=12345,variance=0.1,minibatchSize=1,factorizedDimSize=6,shuffle=true,epochs=5,optimiser=StochasticGradientOptimiser(class-name=org.tribuo.math.optimisers.AdaGrad,epsilon=0.1,initialLearningRate=0.1,initialValue=0.0,host-short-name=StochasticGradientOptimiser),loggingInterval=30000,objective=LabelObjective(class-name=org.tribuo.classification.sgd.objectives.LogMulticlass,host-short-name=LabelObjective),tribuo-version=4.2.0,train-invocation-count=0,is-sequence=false,host-short-name=Trainer),trained-at=2021-12-18T20:36:35.640663-05:00,instance-values={},tribuo-version=4.2.0,java-version=17.0.1,os-name=Mac OS X,os-arch=x86_64)
		model-producer=Tribuo
		model-version=0
		input-name=input
	}
	tribuo-version = 4.2.0
	java-version = 17.0.1
	os-name = Mac OS X
	os-arch = x86_64
)
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The <code>ONNXExternalModel</code> provenance has a lot of placeholders in it, as you might expect given the information is not always present in ONNX files.</p>
<p>We can load the Tribuo model provenance using <code>getTribuoProvenance()</code>:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[13]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-java"><pre><span></span><span class="kd">var</span> <span class="n">tribuoProvenance</span> <span class="o">=</span> <span class="n">onnx</span><span class="p">.</span><span class="na">getTribuoProvenance</span><span class="p">().</span><span class="na">get</span><span class="p">();</span>
<span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">ProvenanceUtil</span><span class="p">.</span><span class="na">formattedProvenanceString</span><span class="p">(</span><span class="n">tribuoProvenance</span><span class="p">));</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>FMClassificationModel(
	class-name = org.tribuo.classification.sgd.fm.FMClassificationModel
	dataset = MutableDataset(
			class-name = org.tribuo.MutableDataset
			datasource = IDXDataSource(
					class-name = org.tribuo.datasource.IDXDataSource
					outputFactory = LabelFactory(
							class-name = org.tribuo.classification.LabelFactory
						)
					outputPath = /Users/apocock/Development/Tribuo/tutorials/train-labels-idx1-ubyte.gz
					featuresPath = /Users/apocock/Development/Tribuo/tutorials/train-images-idx3-ubyte.gz
					features-file-modified-time = 2000-07-21T14:20:24-04:00
					output-resource-hash = 3552534A0A558BBED6AED32B30C495CCA23D567EC52CAC8BE1A0730E8010255C
					datasource-creation-time = 2021-12-18T20:36:23.109293-05:00
					output-file-modified-time = 2000-07-21T14:20:27-04:00
					idx-feature-type = UBYTE
					features-resource-hash = 440FCABF73CC546FA21475E81EA370265605F56BE210A4024D2CA8F203523609
					host-short-name = DataSource
				)
			transformations = List[]
			is-sequence = false
			is-dense = false
			num-examples = 60000
			num-features = 717
			num-outputs = 10
			tribuo-version = 4.2.0
		)
	trainer = FMClassificationTrainer(
			class-name = org.tribuo.classification.sgd.fm.FMClassificationTrainer
			seed = 12345
			variance = 0.1
			minibatchSize = 1
			factorizedDimSize = 6
			shuffle = true
			epochs = 5
			optimiser = AdaGrad(
					class-name = org.tribuo.math.optimisers.AdaGrad
					epsilon = 0.1
					initialLearningRate = 0.1
					initialValue = 0.0
					host-short-name = StochasticGradientOptimiser
				)
			loggingInterval = 30000
			objective = LogMulticlass(
					class-name = org.tribuo.classification.sgd.objectives.LogMulticlass
					host-short-name = LabelObjective
				)
			tribuo-version = 4.2.0
			train-invocation-count = 0
			is-sequence = false
			host-short-name = Trainer
		)
	trained-at = 2021-12-18T20:36:35.640663-05:00
	instance-values = Map{}
	tribuo-version = 4.2.0
	java-version = 17.0.1
	os-name = Mac OS X
	os-arch = x86_64
)
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>From this provenance we can see that the model is a factorization machine running on MNIST (as expected). So now we can build a <code>ReproUtil</code> and rebuild the model.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[14]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-java"><pre><span></span><span class="kd">var</span> <span class="n">mnistRepro</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ReproUtil</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">tribuoProvenance</span><span class="p">,</span><span class="n">Label</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>

<span class="kd">var</span> <span class="n">reproducedMNISTModel</span> <span class="o">=</span> <span class="n">mnistRepro</span><span class="p">.</span><span class="na">reproduceFromProvenance</span><span class="p">();</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We can diff the two provenances:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[15]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-java"><pre><span></span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">ReproUtil</span><span class="p">.</span><span class="na">diffProvenance</span><span class="p">(</span><span class="n">tribuoProvenance</span><span class="p">,</span> <span class="n">reproducedMNISTModel</span><span class="p">.</span><span class="na">getProvenance</span><span class="p">()));</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>{
  &#34;dataset&#34; : {
    &#34;datasource&#34; : {
      &#34;datasource-creation-time&#34; : {
        &#34;original&#34; : &#34;2021-12-18T20:36:23.109293-05:00&#34;,
        &#34;reproduced&#34; : &#34;2021-12-18T20:38:58.740193-05:00&#34;
      }
    }
  },
  &#34;trained-at&#34; : {
    &#34;original&#34; : &#34;2021-12-18T20:36:35.640663-05:00&#34;,
    &#34;reproduced&#34; : &#34;2021-12-18T20:39:09.831081-05:00&#34;
  }
}
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>As before, it's not very interesting as we're using the same files and so only the creation timestamps are differing. Checking the model weights is tricky with an ONNX model, so we can instead check that the predictions are the same (though Tribuo computes in doubles and ONNX Runtime uses floats so the answers are slightly different). We'll borrow the <code>checkPredictions</code> function from the ONNX export tutorial.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[16]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-java"><pre><span></span><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">checkPredictions</span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Prediction</span><span class="o">&lt;</span><span class="n">Label</span><span class="o">&gt;&gt;</span> <span class="n">nativePredictions</span><span class="p">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Prediction</span><span class="o">&lt;</span><span class="n">Label</span><span class="o">&gt;&gt;</span> <span class="n">onnxPredictions</span><span class="p">,</span> <span class="kt">double</span> <span class="n">delta</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nativePredictions</span><span class="p">.</span><span class="na">size</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Prediction</span><span class="o">&lt;</span><span class="n">Label</span><span class="o">&gt;</span> <span class="n">tribuo</span> <span class="o">=</span> <span class="n">nativePredictions</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
        <span class="n">Prediction</span><span class="o">&lt;</span><span class="n">Label</span><span class="o">&gt;</span> <span class="n">external</span> <span class="o">=</span> <span class="n">onnxPredictions</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
        <span class="c1">// Check the predicted label</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tribuo</span><span class="p">.</span><span class="na">getOutput</span><span class="p">().</span><span class="na">getLabel</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span><span class="n">external</span><span class="p">.</span><span class="na">getOutput</span><span class="p">().</span><span class="na">getLabel</span><span class="p">()))</span> <span class="p">{</span>
            <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;At index &quot;</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="s">&quot; predictions are not equal - &quot;</span>
                    <span class="o">+</span> <span class="n">tribuo</span><span class="p">.</span><span class="na">getOutput</span><span class="p">().</span><span class="na">getLabel</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot; and &quot;</span>
                    <span class="o">+</span> <span class="n">external</span><span class="p">.</span><span class="na">getOutput</span><span class="p">().</span><span class="na">getLabel</span><span class="p">());</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="c1">// Check the maximum score</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">Math</span><span class="p">.</span><span class="na">abs</span><span class="p">(</span><span class="n">tribuo</span><span class="p">.</span><span class="na">getOutput</span><span class="p">().</span><span class="na">getScore</span><span class="p">()</span> <span class="o">-</span> <span class="n">external</span><span class="p">.</span><span class="na">getOutput</span><span class="p">().</span><span class="na">getScore</span><span class="p">())</span> <span class="o">&gt;</span> <span class="n">delta</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;At index &quot;</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="s">&quot; predictions are not equal - &quot;</span>
                    <span class="o">+</span> <span class="n">tribuo</span><span class="p">.</span><span class="na">getOutput</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot; and &quot;</span>
                    <span class="o">+</span> <span class="n">external</span><span class="p">.</span><span class="na">getOutput</span><span class="p">());</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="c1">// Check the score distribution</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">Map</span><span class="p">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Label</span><span class="o">&gt;</span> <span class="n">l</span> <span class="p">:</span> <span class="n">tribuo</span><span class="p">.</span><span class="na">getOutputScores</span><span class="p">().</span><span class="na">entrySet</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">Label</span> <span class="n">other</span> <span class="o">=</span> <span class="n">external</span><span class="p">.</span><span class="na">getOutputScores</span><span class="p">().</span><span class="na">get</span><span class="p">(</span><span class="n">l</span><span class="p">.</span><span class="na">getKey</span><span class="p">());</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">other</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;At index &quot;</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="s">&quot; failed to find label &quot;</span> <span class="o">+</span> <span class="n">l</span><span class="p">.</span><span class="na">getKey</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot; in ORT prediction.&quot;</span><span class="p">);</span>
                <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">Math</span><span class="p">.</span><span class="na">abs</span><span class="p">(</span><span class="n">l</span><span class="p">.</span><span class="na">getValue</span><span class="p">().</span><span class="na">getScore</span><span class="p">()</span> <span class="o">-</span> <span class="n">other</span><span class="p">.</span><span class="na">getScore</span><span class="p">())</span> <span class="o">&gt;</span> <span class="n">delta</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;At index &quot;</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="s">&quot; predictions are not equal - &quot;</span>
                            <span class="o">+</span> <span class="n">tribuo</span><span class="p">.</span><span class="na">getOutputScores</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot; and &quot;</span>
                            <span class="o">+</span> <span class="n">external</span><span class="p">.</span><span class="na">getOutputScores</span><span class="p">());</span>
                    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now we can make predictions from both models and compare the outputs:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[17]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-java"><pre><span></span><span class="kd">var</span> <span class="n">onnxPredictions</span> <span class="o">=</span> <span class="n">onnx</span><span class="p">.</span><span class="na">predict</span><span class="p">(</span><span class="n">mnistTest</span><span class="p">);</span>
<span class="kd">var</span> <span class="n">reproducedPredictions</span> <span class="o">=</span> <span class="n">reproducedMNISTModel</span><span class="p">.</span><span class="na">predict</span><span class="p">(</span><span class="n">mnistTest</span><span class="p">);</span>

<span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Predictions are equal = &quot;</span> <span class="o">+</span> <span class="n">checkPredictions</span><span class="p">(</span><span class="n">reproducedPredictions</span><span class="p">,</span><span class="n">onnxPredictions</span><span class="p">,</span><span class="mf">1e-5</span><span class="p">));</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>Predictions are equal = true
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Working-with-provenance-diffs">Working with provenance diffs<a class="anchor-link" href="#Working-with-provenance-diffs">&#182;</a></h2><p>We can use the provenance diff methods to compute diffs for unrelated models too. We're going to train a logistic regression on MNIST and compare the model provenance against the ONNX factorization machine we just used.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[18]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-java"><pre><span></span><span class="kd">var</span> <span class="n">lrTrainer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LogisticRegressionTrainer</span><span class="p">();</span>
<span class="kd">var</span> <span class="n">lrModel</span> <span class="o">=</span> <span class="n">lrTrainer</span><span class="p">.</span><span class="na">train</span><span class="p">(</span><span class="n">mnistTrain</span><span class="p">);</span>

<span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">ReproUtil</span><span class="p">.</span><span class="na">diffProvenance</span><span class="p">(</span><span class="n">tribuoProvenance</span><span class="p">,</span> <span class="n">lrModel</span><span class="p">.</span><span class="na">getProvenance</span><span class="p">()));</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>{
  &#34;class-name&#34; : {
    &#34;original&#34; : &#34;org.tribuo.classification.sgd.fm.FMClassificationModel&#34;,
    &#34;reproduced&#34; : &#34;org.tribuo.classification.sgd.linear.LinearSGDModel&#34;
  },
  &#34;dataset&#34; : {
    &#34;datasource&#34; : {
      &#34;datasource-creation-time&#34; : {
        &#34;original&#34; : &#34;2021-12-18T20:36:23.109293-05:00&#34;,
        &#34;reproduced&#34; : &#34;2021-12-18T20:38:51.027212-05:00&#34;
      }
    }
  },
  &#34;trained-at&#34; : {
    &#34;original&#34; : &#34;2021-12-18T20:36:35.640663-05:00&#34;,
    &#34;reproduced&#34; : &#34;2021-12-18T20:39:18.280345-05:00&#34;
  },
  &#34;trainer&#34; : {
    &#34;class-name&#34; : {
      &#34;original&#34; : &#34;org.tribuo.classification.sgd.fm.FMClassificationTrainer&#34;,
      &#34;reproduced&#34; : &#34;org.tribuo.classification.sgd.linear.LogisticRegressionTrainer&#34;
    },
    &#34;loggingInterval&#34; : {
      &#34;original&#34; : &#34;30000&#34;,
      &#34;reproduced&#34; : &#34;1000&#34;
    },
    &#34;optimiser&#34; : {
      &#34;initialLearningRate&#34; : {
        &#34;original&#34; : &#34;0.1&#34;,
        &#34;reproduced&#34; : &#34;1.0&#34;
      }
    },
    &#34;factorizedDimSize&#34; : {
      &#34;original&#34; : &#34;6&#34;
    },
    &#34;variance&#34; : {
      &#34;original&#34; : &#34;0.1&#34;
    }
  }
}
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This diff is longer than the others we've seen, as expected for two different models with different trainers. As expected the dataset section is mostly empty as both models are trained on an unmodified MNIST training set. The <code>FMClassificationTrainer</code> and <code>LogisticRegressionTrainer</code> show more differences, but as both are SGD based models there are many common fields. They share fields like a loss function (both used <code>LogMulticlass</code>), a gradient optimiser (both used <code>AdaGrad</code>), the number of training epochs, and the minibatch size. They used different learning rates (which do appear in the diff under <code>optimiser</code>) and the factorization machine also has a few extra parameters not found in the logistic regression, <code>factorizedDimSize</code> and <code>variance</code>, which are reported as just having an <code>original</code> value, meaning they are only found in the first provenance and not the second.</p>
<p>The current diff format is JSON, and designed to be easily human readable. We left designing a navigable diff object which is easily inspectable from code to future work once we have a better understanding of how people want to use the generated diffs.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Conclusion">Conclusion<a class="anchor-link" href="#Conclusion">&#182;</a></h2><p>We showed how to load in Tribuo models and reproduce them using our automated reproducibility system. The system executes the same computations as the original training, which in most cases results in an identical model. We have noted that there are some differences between gradient descent based models that are trained on ARM and x86 architectures due to underlying differences in the JVM, but otherwise the reproductions are exact. Over time we plan to expand this reproducibility system into a full experimental framework allowing models to be rebuilt using different datasets, data transformations or training hyperparameters holding all other parameters constant.</p>

</div>
</div>
</div>
    </div>
  </div>
</body>

