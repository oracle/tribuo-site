#!/bin/bash

SYS=$(uname -s)
HEAD="head"
case $SYS in
    Darwin)
        GHEAD=$(command -v ghead)
        if [ -z "$GHEAD" ]; then
            echo "Since you're on a Mac, you'll need to 'brew install coreutils' first"
            exit
        fi
        HEAD="$GHEAD"
        ;;
esac

JUPYTER=$(command -v jupyter)
if [ -z "$JUPYTER" ]; then
    echo "Jupyter not found in path. Please install jupyter."
    exit
fi

SITE_ROOT=$(git rev-parse --show-toplevel)
DOC_VERSION=$(grep doc_version: $SITE_ROOT/_config.yml |awk -F: '{print $2}' |xargs)

TRIBUO_DIR="${SITE_ROOT}/tribuo"
if [[ $# -eq 1 ]] ; then
    TRIBUO_DIR=$1
fi

TUTORIALS=$(ls "${TRIBUO_DIR}"/tutorials/*.ipynb)

#
# Make the tutorial directory if it doesn't exist
TUTORIAL_OUTPUT_DIR=${SITE_ROOT}/learn/$DOC_VERSION/tutorials
mkdir -p ${TUTORIAL_OUTPUT_DIR}

UNORDERED=320
for tut in $TUTORIALS; do
    # You know what's not so great? Converting this to markdown first to get
    # the title easily.  But guess what?  Here we go!
    $JUPYTER nbconvert --to markdown $tut > /dev/null 2>&1
    MD="${tut%.*}.md"
    TITLE=$($HEAD -1 "$MD" |sed s/\#// |sed s/Tutorial// |xargs)

    # Is this a recognized title?
    case $TITLE in
        Classification*)
            ORDER=301
            ;;
        *K-Means*)
            ORDER=302
            ;;
        *HDBSCAN*)
            ORDER=303
            ;;
        *Regression*)
            ORDER=304
            ;;
        *Anomaly*)
            ORDER=305
            ;;
        *Multi-Label*)
            ORDER=306
            ;;
        *Configuration*)
            ORDER=307
            ;;
        *columnar*)
            ORDER=308
            TITLE="Loading Columnar Data"
            ;;
        *Working\ with\ external*)
            ORDER=309
            TITLE="External Models"
            ;;
        *Model\ export*)
            ORDER=310
            TITLE="ONNX export and OCI deployment"
            ;;
        *Document*)
            ORDER=311
            TITLE="Document Classification"
            ;;
        *TensorFlow*)
            ORDER=312
            TITLE="Deep Learning with TensorFlow"
            ;;
        *Reproducibility*)
            ORDER=313
            ;;
        *Feature*)
            ORDER=314
            ;;
        *)
            ORDER=$UNORDERED
            UNORDERED=$(($UNORDERED + 1))
            ;;
    esac

    # Convert the notebook to html
    # We use the classic template as the html output changed in nbconvert 6 - https://blog.jupyter.org/the-templating-system-of-nbconvert-6-47ea781eacd2
    $JUPYTER nbconvert --to html --template classic $tut > /dev/null 2>&1
    HTML="${tut%.*}.html"
    TARGET=${TUTORIAL_OUTPUT_DIR}/$(basename $HTML)
    NOTEBOOK_URL="https://github.com/oracle/tribuo/blob/main/tutorials/$(basename $tut)"

    cat << EOF > $TARGET
---
title: "$TITLE"
og-title: "$TITLE Tutorial"
learn_nav: true
parent: Tutorials
nav_order: $ORDER
is_notebook: true
notebook_url: $NOTEBOOK_URL
comment: ## DO NOT EDIT THIS FILE. IT IS COPIED FROM THE TRIBUO DOC. EDIT IT THERE. ##
---
EOF
    tail -n +`awk '/    <div class="container" id="notebook-container">/ {print FNR}' $HTML ` $HTML |$HEAD -n -7 >> $TARGET
    echo "Created $TARGET"
    rm $HTML
    rm $MD
done
