#!/bin/bash

# Pick and choose the specific docs we want to add
SITE_ROOT=$(git rev-parse --show-toplevel)
DOC_VERSION=$(grep doc_version: $SITE_ROOT/_config.yml |awk -F: '{print $2}' |xargs)
DOC_DIR="$SITE_ROOT/learn/$DOC_VERSION/docs"

TRIBUO_DIR="${SITE_ROOT}/tribuo"
if [[ $# -eq 1 ]] ; then
    TRIBUO_DIR=$1
fi

TRIBUO_DOC_DIR="${TRIBUO_DIR}/docs/"

DOCS="Architecture.md PackageOverview.md Security.md"

#
# Make docs dir if it doesn't already exist
mkdir -p $DOC_DIR

#
# Copy in each doc, adding appropriate frontmatter
for doc in $DOCS; do
    LOWERCASE=$(echo $doc |tr '[:upper:]' '[:lower:]')
    case $doc in
        Architecture.md)
            ORDER=202
            TITLE="Architecture"
            ;;
        PackageOverview.md)
            ORDER=203
            TITLE="Package Overview"
            ;;
        Security.md)
            ORDER=204
            TITLE="Security"
            ;;
        *)
            echo "Unrecognized doc, please add a case option for it"
            ;;
    esac
    cat << EOF > $DOC_DIR/$LOWERCASE
---
title: $TITLE
learn_nav: true
parent: Docs
nav_order: $ORDER
comment: ## DO NOT EDIT THIS FILE. IT IS COPIED FROM THE TRIBUO DOC. EDIT IT THERE. ##
---
EOF
    # Put in the title, then a table of contents, then the rest of the file
    head -1 $TRIBUO_DOC_DIR/$doc >> $DOC_DIR/$LOWERCASE
    cat << EOF >> $DOC_DIR/$LOWERCASE
{:.no_toc}

* TOC
{:toc}
EOF
    tail -n +2 $TRIBUO_DOC_DIR/$doc  | sed  'H;1h;$!d;x; s/|\n\n\n*/|\
{: .table .table-responsive}\
\
/g' >> $DOC_DIR/$LOWERCASE
    # Check if we ended with a table
    LASTCHAR=$(tail -c 2 $TRIBUO_DOC_DIR/$doc)
    if [ "$LASTCHAR" = "|" ]; then
      echo "lastchar"
      cat << EOF >> $TRIBUO_DOC_DIR/$doc
{: .table}
EOF
    fi
    echo "Copied $DOC_DIR/$LOWERCASE"
done

#
# Copy in the FAQ to the right place
cat << EOF > $SITE_ROOT/learn/$DOC_VERSION/faq.md
---
title: FAQ
learn_nav: true
has_children: true
nav_order: 104
comment: ## DO NOT EDIT THIS FILE. IT IS COPIED FROM THE TRIBUO DOC. EDIT IT THERE. ##
---
EOF
# Put in the title, then a table of contents, then the rest of the file
head -1 $TRIBUO_DOC_DIR/FAQs.md >> $SITE_ROOT/learn/$DOC_VERSION/faq.md
cat << EOF >> $SITE_ROOT/learn/$DOC_VERSION/faq.md
{:.no_toc}

![faq graphic](https://tribuo.org/assets/img/faq.svg)

* TOC
{:toc}
EOF
tail -n +2 $TRIBUO_DOC_DIR/FAQs.md >> $SITE_ROOT/learn/$DOC_VERSION/faq.md
echo "Copied $SITE_ROOT/learn/$DOC_VERSION/faq.md"

#
# Copy in the data flow diagram so that we don't have to change the link
if [ ! -d $DOC_DIR/img ]; then
    mkdir $DOC_DIR/img
fi

cp $TRIBUO_DOC_DIR/img/tribuo-data-flow.png $DOC_DIR/img

# Finally copy in the jep-290-allowlist that the Security doc references
cp $TRIBUO_DOC_DIR/jep-290-filter.txt $DOC_DIR
